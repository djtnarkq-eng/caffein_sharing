<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì²­ì†Œë…„ ì¹´í˜ì¸ ì¼€ì–´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #064e3b;
      background: #ecfdf5;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #bbf7d0 0, #ecfdf5 45%, #f0fdf4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 80px;
      width: 100%;
    }
    header {
      margin-top: 4px;
      margin-bottom: 10px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:16px;
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #22c55e;
      color: #f0fdf4;
      font-weight: 700;
      font-size: 1.2rem;
      box-shadow: 0 10px 20px rgba(22,163,74,0.35);
    }
    header h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: -0.02em;
      color:#064e3b;
    }
    header p {
      margin: 6px 0 0;
      font-size: 0.9rem;
      color: #047857;
    }

    .panel {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 20px rgba(22,101,52,0.05);
      margin-bottom: 12px;
      border:1px solid #bbf7d0;
    }
    .panel-title {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .panel-title-left {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .panel-title-left span:first-child {
      font-size:0.95rem;
      font-weight:600;
      color:#065f46;
    }
    .panel-title-left span:last-child {
      font-size:0.78rem;
      color:#047857;
    }

    .small { font-size:0.8rem; color:#065f46; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > div { flex:1; min-width:140px; }

    label { font-size:0.88rem; display:block; margin:6px 0 3px; color:#065f46; }
    input, select, textarea {
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #a7f3d0;
      font-size:0.9rem;
      font-family:inherit;
      box-sizing:border-box;
      background:#f0fdf4;
      color:#064e3b;
    }
    textarea { resize:vertical; min-height:60px; }
    input[type="file"] { padding:3px 0; }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,0.4);
      background:#ecfdf5;
    }

    .btn {
      padding:8px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.88rem;
      font-weight:600;
    }
    .btn-primary {
      background:#16a34a;
      color:#f0fdf4;
    }
    .btn-outline {
      background:#ecfdf5;
      color:#15803d;
      border:1px solid #22c55e;
    }
    .btn-ghost {
      background:transparent;
      color:#15803d;
      border:1px dashed #6ee7b7;
    }
    .btn:active { transform:translateY(1px) scale(0.98); }

    .top-layout { display:flex; flex-wrap:wrap; gap:12px; }
    .top-left { flex:0 0 260px; min-width:220px; }
    .top-right { flex:1; min-width:260px; }

    /* ===== í™ˆ í™”ë©´: ì»µ ì¤‘ì•™ ì •ë ¬ + ì²´ì¤‘ ìƒì ===== */
    #view-home {
      margin-top: 10px;
      display:block;
    }
    .home-top-wrapper {
      position: relative;
      width: 100%;
      max-width: 760px;
      margin: 40px auto 16px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .cup-center-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .weight-info-box {
      position: absolute;
      right: 0;
      top: -10px;
      width: 240px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #bbf7d0;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.38;
      color: #065f46;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    @media (max-width: 600px) {
      .home-top-wrapper {
        flex-direction: column;
      }
      .weight-info-box {
        position: static;
        width: 100%;
        margin-top: 16px;
      }
    }

    /* ì»µ ê²Œì´ì§€ */
    .cup-shell {
      display:flex;
      justify-content:center;
      margin:6px 0 4px;
      transition:background 0.5s ease;
      cursor:pointer;
    }
    .cup-body {
      position:relative;
      width:150px;
      height:200px;
      clip-path: polygon(5% 4%, 95% 4%, 82% 100%, 18% 100%);
      border-radius:22px 22px 30px 30px;
      border:3px solid rgba(0,0,0,0.45);
      background:rgba(255,255,255,0.98);
      overflow:hidden;
      box-shadow:0 10px 18px rgba(21,128,61,0.18);
    }
    .cup-fill {
      position:absolute;
      left:0;
      bottom:0;
      width:100%;
      height:0%;
      background:linear-gradient(to top,#78350f,#d97757);
      transition:height 0.6s ease;
    }
    .cup-text {
      position:absolute;
      top:60%;
      left:50%;
      transform:translate(-50%,-50%);
      font-size:1rem;
      font-weight:600;
      color:#052e16;
      text-shadow:0 1px 2px rgba(255,255,255,0.9);
      white-space:nowrap;
    }
    .cup-mark {
      position:absolute;
      left:0;
      right:0;
      bottom:66.666%;
      height:2px;
      background:repeating-linear-gradient(
        to right,
        rgba(22,163,74,0.9) 0px,
        rgba(22,163,74,0.9) 6px,
        transparent 6px,
        transparent 10px
      );
      pointer-events:none;
    }
    /* ëˆˆê¸ˆì„  ì™¼ìª½ ë§í’ì„  */
    .cup-mark-label {
      position:absolute;
      right:100%;
      bottom:calc(66.666% - 2px);
      margin-right:10px;
      font-size:0.72rem;
      color:#065f46;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(236,253,245,0.98);
      box-shadow:0 0 0 1px rgba(16,185,129,0.45);
      white-space:nowrap;
    }
    .cup-mark-label::after {
      content:"";
      position:absolute;
      left:100%;
      top:50%;
      transform:translateY(-50%);
      border-width:6px;
      border-style:solid;
      border-color:transparent transparent transparent rgba(236,253,245,0.98);
    }

    .cup-shell.alert {
      background:radial-gradient(circle at center,rgba(248,113,113,0.28) 0, transparent 70%);
    }
    .cup-body.shake {
      animation:cupShake 0.4s ease-in-out infinite;
    }
    @keyframes cupShake {
      0% { transform:translateX(0) rotate(0); }
      20% { transform:translateX(-2px) rotate(-2deg); }
      40% { transform:translateX(2px) rotate(2deg); }
      60% { transform:translateX(-1.5px) rotate(-1.5deg); }
      80% { transform:translateX(1.5px) rotate(1.5deg); }
      100% { transform:translateX(0) rotate(0); }
    }

    .stat-row {
      display:flex;
      justify-content:space-between;
      font-size:0.9rem;
      margin:2px 0;
    }

    .stats-layout { display:flex; flex-wrap:wrap; gap:10px; }
    .stats-detail-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #bbf7d0;
      background: #f0fdf4;
    }
    .stats-detail-block h4 {
      margin: 0 0 4px;
      font-size: 0.9rem;
      color: #065f46;
    }
    .stats-chart-wrap { flex:1.6; min-width:260px; height:230px; }
    .stats-cal-wrap { flex:1; min-width:220px; }
    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:2px;
      margin-top:4px;
      font-size:0.78rem;
    }
    .calendar-day-header {
      text-align:center;
      font-weight:600;
      padding:2px 0;
      color:#047857;
    }
    .calendar-day {
      height:22px;
      border-radius:6px;
      text-align:center;
      line-height:22px;
      background:#e5f7ef;
      color:#064e3b;
    }
    .calendar-day.has-intake { font-weight:600; }
    .calendar-legend { margin-top:4px; font-size:0.75rem; color:#047857; }

    .effect-icon-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:6px 0;
    }
    .effect-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid #a7f3d0;
      font-size:0.8rem;
      background:#ecfdf5;
      cursor:pointer;
      color:#065f46;
    }
    .effect-chip span:first-child { font-size:1.1rem; }
    .effect-chip.active {
      background:#fee2e2;
      border-color:#f97316;
      color:#b45309;
    }
.product-icon-row {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin:6px 0;
}
.product-shortcut-chip {
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid #a7f3d0;
  font-size:0.8rem;
  background:#ecfdf5;
  cursor:pointer;
  color:#065f46;
}
.product-shortcut-chip span:first-child {
  font-size:1.1rem;
}
.product-shortcut-chip.active {
  background:#dcfce7;
  border-color:#22c55e;
  color:#166534;
}
    .effect-tips {
      font-size:0.8rem;
      background:#fefce8;
      border-radius:8px;
      padding:6px 8px;
      margin-top:4px;
      border:1px solid #facc15;
      color:#854d0e;
    }
    .effect-list-item {
      display:flex;
      justify-content:space-between;
      gap:6px;
      padding:4px 0;
      border-bottom:1px dashed #d1fae5;
      font-size:0.8rem;
      color:#065f46;
    }

    .banner-cards {
      display:flex;
      flex-wrap:nowrap;
      gap:12px;
      margin-top:8px;
    }
    .banner-card {
      flex:1.3;
      min-width:260px;
      border-radius:12px;
      border:1px solid #6ee7b7;
      padding:8px;
      font-size:0.8rem;
      background:#ecfdf5;
    }
    .banner-card-title {
      font-size:0.85rem;
      font-weight:600;
      color:#047857;
      margin-bottom:4px;
    }

    .bottom-nav {
      position:fixed;
      left:0; right:0; bottom:0;
      padding:8px 12px 14px;
      background:rgba(240,253,250,0.96);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(110,231,183,0.9);
      display:flex;
      justify-content:center;
      z-index: 10;
    }
    .bottom-nav-inner {
      max-width:1100px;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .nav-pill {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      border-radius:999px;
      padding:7px 10px;
      font-size:0.85rem;
      border:none;
      background:#166534;
      color:#ecfdf5;
      cursor:pointer;
    }
    .nav-dot {
      width:7px; height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 6px rgba(34,197,94,0.25);
    }
    @media (max-width: 720px) {
      .stats-layout { flex-direction:column; }
      .top-layout { flex-direction:column; }
      .banner-cards { flex-direction:column; }
    }

    /* í™”ë©´ ë·° í† ê¸€ */
    #view-intake { margin-top:4px; display:none; }
    #view-extra { margin-top:4px; display:none; }

    /* ë“œë˜ê·¸ íŒíŠ¸ */
    .drag-hint {
      margin-top:10px;
      text-align:center;
      font-size:0.8rem;
      color:#047857;
      cursor: pointer;
    }
    .drag-handle {
      width:60px;
      height:4px;
      border-radius:999px;
      margin:4px auto 2px;
      background:rgba(22,163,74,0.5);
    }

    /* í”Œë¡œíŒ… ë²„íŠ¼ & ì˜¤ë²„ë ˆì´ */
    #fab-menu-button {
      position: fixed;
      bottom: 85px;
      right: 22px;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: #22c55e;
      color: white;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(34,197,94,0.35);
      cursor: pointer;
      z-index: 999;
      transition: transform 0.2s ease;
    }
    #fab-menu-button:active {
      transform: scale(0.9);
    }
    #fab-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 998;
    }
    #fab-menu {
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 16px;
      width: 220px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #fab-menu button {
      padding: 10px 12px;
      font-size: 0.9rem;
      background: #ecfdf5;
      border: 1px solid #6ee7b7;
      border-radius: 10px;
      color: #065f46;
      cursor: pointer;
    }
    #fab-menu button:active {
      background: #d1fae5;
    }

    /* í…ìŠ¤íŠ¸ ê°€ë…ì„± ê³µí†µ */
    .responsive-text-block {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 8px 12px;
      line-height: 1.45;
      font-size: 0.9rem;
      word-break: keep-all;
      overflow-wrap: break-word;
      color: #065f46;
      text-align:center;
    }
    @media (min-width: 600px) {
      .responsive-text-block {
        max-width: 540px;
        font-size: 0.95rem;
        line-height: 1.55;
      }
    }
    @media (min-width: 900px) {
      .responsive-text-block {
        max-width: 620px;
        font-size: 1rem;
        line-height: 1.6;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-row">
      <div class="logo-circle">C</div>
      <div>
        <h1>ì²­ì†Œë…„ ì¹´í˜ì¸ ì¼€ì–´</h1>
        <p>í™ˆ(ì»µ) Â· ì„­ì·¨ ê¸°ë¡ Â· ì¶”ê°€ ê¸°ëŠ¥(í†µí•©+ì„¸ë¶€ í™”ë©´)ì„ ë¶„ë¦¬í•´ì„œ ì‚¬ìš©í•´ìš”.</p>
      </div>
    </div>
  </header>

  <!-- ===== 1. í™ˆ í™”ë©´ ===== -->
  <div id="view-home">
    <section class="panel" style="background:transparent; box-shadow:none; border:none; padding:0;">
      <div class="home-top-wrapper">
        <!-- ê°€ìš´ë° ì»µ -->
        <div class="cup-center-box">
          <div class="cup-shell" id="cup-gauge" onclick="openIntake()">
            <div class="cup-body">
              <div class="cup-fill" id="cup-fill"></div>
              <div class="cup-mark"></div>
              <div class="cup-mark-label" id="cup-mark-label">ì¼ì¼ ê¶Œì¥ ì„­ì·¨ëŸ‰</div>
              <div class="cup-text" id="cup-text">0 mg</div>
            </div>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ ì²´ì¤‘ ì…ë ¥ -->
        <div class="weight-info-box">
          <label for="weight-kg">ì²´ì¤‘ (ì„ íƒ ì…ë ¥)</label>
          <input
            type="number"
            id="weight-kg"
            min="30"
            max="120"
            placeholder="ì˜ˆ: 60"
          />
          <div class="small" style="margin-top:4px;">
            * ì²´ì¤‘ì„ ì…ë ¥í•˜ë©´ ê¶Œì¥ ì„­ì·¨ëŸ‰ ëˆˆê¸ˆì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
            (kgë‹¹ 2.5 mg ê¸°ì¤€)
          </div>
        </div>
      </div>

      <div class="drag-hint responsive-text-block" onclick="showExtraCombined()">
        <div class="drag-handle"></div>
        í™”ë©´ì„ <b>ìœ„ë¡œ ëŒì–´ì˜¬ë¦¬ê±°ë‚˜ ì´ ì˜ì—­ì„ í„°ì¹˜í•˜ë©´</b><br>
        í†µê³„ Â· í˜ˆì¤‘ ë†ë„ Â· ë¶€ì‘ìš© Â· ì •ë³´/ë°°ë„ˆ ë“±<br>
        <b>ì¶”ê°€ ê¸°ëŠ¥ í†µí•© í™”ë©´</b>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
      </div>
    </section>
  </div>

  <!-- ===== 2. ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡ í™”ë©´ ===== -->
  <div id="view-intake">
    <button type="button" class="btn btn-outline" onclick="goHome()" style="margin-bottom:8px;">
      â¬… ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ
    </button>

    <section class="panel">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡</span>
          <span class="small">ì‚¬ì§„/ì œí’ˆëª… ìë™ ì¶”ì • + ì˜¤ëŠ˜ ìš”ì•½</span>
        </div>
      </div>
      <div class="top-layout">
        <div class="top-right">
          <form id="intake-form">
            <label>ì œí’ˆ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
            <input type="file" id="photo-input" accept="image/*" />
            <div class="small" id="photo-hint">
              * íŒŒì¼ëª…ì— <b>coffee</b>, <b>energy</b>, <b>tea</b>, <b>cola</b>, <b>choco</b>, <b>snack</b> ë“±ì´ ë“¤ì–´ê°€ë©´
              ì¹´í˜ì¸ ìŒë£ŒÂ·ì‹í’ˆì˜ ì–‘ì„ ëŒ€ëµ ì¶”ì •í•©ë‹ˆë‹¤.
            </div>

            <div class="row">
              <div>
                <label>ì œí’ˆ/ìŒì‹ ì´ë¦„</label>
                <div class="row" style="align-items:flex-end;">
                  <div style="flex:2; min-width:160px;">
                    <input type="text" id="product-name" placeholder="ì˜ˆ: ì•„ë©”ë¦¬ì¹´ë…¸, ì—ë„ˆì§€ë“œë§í¬, ì´ˆì½œë¦¿ ì¿ í‚¤" />
                  </div>
                  <div style="flex:1; min-width:110px;">
                    <button type="button" class="btn btn-ghost" id="guess-from-name-btn">ì œí’ˆëª… ê¸°ë°˜ ìë™ ì¶”ì •</button>
                  </div>
                </div>
              </div>
              <div>
                <label>ì¹´í˜ì¸ ì–‘ (mg)</label>
                <input type="number" id="caffeine-mg" min="0" step="1" placeholder="ì˜ˆ: 80" required />
              </div>
            </div>

            <!-- âœ… [PRODUCT ICON UI] ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì•„ì´ì½˜ -->
            <div style="margin-top:6px;">
              <h3 style="margin:0 0 4px; font-size:0.9rem; color:#065f46;">ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´</h3>
              <div class="product-icon-row" id="product-shortcut-icons"></div>
              <div class="small" id="product-shortcut-hint" style="margin-top:4px;">
                ì•„ì´ì½˜ì„ ëˆ„ë¥´ë©´ <b>ì œí’ˆëª… Â· ì¹´í˜ì¸ ì–‘ Â· ì„­ì·¨ëŸ‰ ë©”ëª¨</b>ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
              </div>       
            </div>
            <!-- âœ… [PRODUCT ICON UI ë] -->

          <div class="row">
  <div style="flex:1">
    <label>ì„­ì·¨ëŸ‰ ë©”ëª¨</label>
    <input type="text" id="amount-note" placeholder="ì˜ˆ: 1ìº”, í†¨ ì‚¬ì´ì¦ˆ 1ì”, ì¿ í‚¤ 2ê°œ" />
  </div>

  <div style="flex:1">
    <label>ì„­ì·¨ ì‹œê°</label>
    <input type="datetime-local" id="intake-time" required />
  </div>
</div>

            <div class="row">
              <div>
                <label>ì‹ì „/ì‹í›„/ê³µë³µ</label>
                <select id="meal-timing">
                  <option value="BEFORE">ì‹ì „</option>
                  <option value="AFTER">ì‹í›„</option>
                  <option value="EMPTY">ê³µë³µ</option>
                </select>
              </div>
              <div>
                <label>êµ¬ë¶„</label>
                <select id="category">
                  <option value="drink">ì¹´í˜ì¸ ìŒë£Œ</option>
                  <option value="food">ì¹´í˜ì¸ ì‹í’ˆ(ë””ì €íŠ¸/ê°„ì‹ ë“±)</option>
                  <option value="medicine">ì•½/ê±´ê°•ë³´ì¡°ì‹í’ˆ</option>
                  <option value="other">ê¸°íƒ€</option>
                </select>
              </div>
            </div>

            <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
              <button type="button" class="btn btn-outline" id="now-btn">í˜„ì¬ ì‹œê°„ìœ¼ë¡œ</button>
              <button type="submit" class="btn btn-primary" id="submit-intake-btn">ê¸°ë¡ ì €ì¥</button>
              <button type="button" class="btn btn-ghost" id="edit-mode-btn">ê¸°ë¡ ìˆ˜ì •</button>
            </div>

            <div id="edit-tools" style="margin-top:6px; display:none;">
              <div class="small" style="margin-bottom:2px;">ìˆ˜ì •í•  ê¸°ë¡ì„ ì„ íƒí•œ ë’¤ â€˜ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸°â€™ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
              <div class="row" style="align-items:flex-end;">
                <div>
                  <select id="edit-intake-select"></select>
                </div>
                <div style="flex:0 0 130px; min-width:115px;">
                  <button type="button" class="btn btn-outline" id="load-intake-btn">ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
              </div>
            </div>
          </form>


          <div style="margin-top:8px;">
            <h3 style="margin:0 0 4px; font-size:0.95rem; color:#065f46;">ì˜¤ëŠ˜ ì„­ì·¨ ìš”ì•½</h3>
            <div id="today-summary">
              <div class="stat-row"><span>ì˜¤ëŠ˜ ì´ ì„­ì·¨ëŸ‰</span><span><b>0 mg</b></span></div>
              <div class="stat-row"><span>ê¸°ë¡ëœ ì„­ì·¨ íšŸìˆ˜</span><span>0íšŒ</span></div>
            </div>
            <div class="small" style="margin-top:4px;">
              * ì´ ì‹œìŠ¤í…œì€ ê¸°ë¡ê³¼ ì¶”ì„¸ í™•ì¸ìš©ì…ë‹ˆë‹¤. ê±´ê°• ë¬¸ì œëŠ” ë³´í˜¸ìÂ·ì „ë¬¸ì˜ì™€ ìƒì˜í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
      </div>
    </section>
<section class="panel" id="product-shortcut-panel">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì¶”ê°€</span>
          <span class="small">
            ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ë©”ë‰´ë¥¼ ì•„ì´ì½˜ìœ¼ë¡œ ì €ì¥í•´ ë‘ê³ ,
            í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.
          </span>
        </div>
      </div>

      <div class="small" style="margin-bottom:6px;">
        ìœ„ì—ì„œ ë³´ì´ëŠ” <b>ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì•„ì´ì½˜</b> ì˜ì—­ê³¼ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
        ì´ ë°•ìŠ¤ì—ì„œ ì¶”ê°€í•œ ë©”ë‰´ëŠ”, ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡ ìƒë‹¨ì˜ ì•„ì´ì½˜ ëª©ë¡ì— ìë™ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
      </div>

      <div class="row" id="product-shortcut-add-row" style="margin-top:2px; align-items:flex-end;">
        <div style="flex:2; min-width:120px;">
          <label style="margin:0 0 2px;">ë©”ë‰´ ì´ë¦„</label>
          <input type="text" id="product-shortcut-name" placeholder="ì˜ˆ: í¸ì˜ì  ìº”ì»¤í”¼" />
        </div>
        <div style="flex:1; min-width:90px;">
          <label style="margin:0 0 2px;">ì¹´í˜ì¸ (mg)</label>
          <input type="number" id="product-shortcut-caffeine" min="0" step="1" placeholder="ì˜ˆ: 80" />
        </div>
        <div style="flex:1; min-width:90px;">
          <label style="margin:0 0 2px;">ìš©ëŸ‰/ë©”ëª¨</label>
          <input type="text" id="product-shortcut-volume" placeholder="ì˜ˆ: 355ml, 24oz" />
        </div>
        <div style="flex:0 0 70px; min-width:60px;">
          <label style="margin:0 0 2px;">ì•„ì´ì½˜</label>
          <input type="text" id="product-shortcut-icon" placeholder="ì˜ˆ: â˜•" maxlength="2" />
        </div>
        <div style="flex:0 0 80px; min-width:70px;">
          <button type="button" class="btn btn-ghost" id="product-shortcut-add-btn">ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== 3. ì¶”ê°€ ê¸°ëŠ¥: í†µí•© + ì„¸ë¶€ ëª¨ë“œ ===== -->
  <div id="view-extra">
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button type="button" class="btn btn-outline" onclick="goHome()">
        â¬… ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ
      </button>
      <button type="button" class="btn btn-ghost" id="extra-back-btn" onclick="setExtraMode(null)" style="display:none;">
        ì „ì²´ ë³´ê¸°
      </button>
    </div>

    <!-- 3-1 í†µê³„ -->
    <section class="panel" id="extra-section-stats">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>í†µê³„ Â· ë˜ë˜ í‰ê·  Â· ì›” ìº˜ë¦°ë”</span>
          <span class="small">ê¸°ê°„ë³„ ë§‰ëŒ€ê·¸ë˜í”„ + ìœ ì‚¬ ì²´ì¤‘/ë™ì¼ ë‚˜ì´ ì‹¤ì„  ë¹„êµ</span>
        </div>
        <button type="button" class="btn btn-ghost" onclick="openStatsDetail()">ì „ì²´ í™”ë©´</button>
      </div>
      <div class="row">
        <div class="row" style="flex:1; align-items:flex-end;">
          <div style="flex:1; min-width:140px;">
            <label>ê¸°ê°„ ì„ íƒ</label>
            <select id="period-select">
              <option value="day">ì˜¤ëŠ˜ (ì‹œê°„ëŒ€ë³„)</option>
              <option value="week">ìµœê·¼ 7ì¼ (ì¼ë³„)</option>
              <option value="month">ì´ë²ˆ ë‹¬ (ì¼ë³„)</option>
              <option value="year">ì˜¬í•´ (ì›”ë³„)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="stats-layout" style="margin-top:6px;">
        <div class="stats-chart-wrap">
          <canvas id="stats-chart"></canvas>
        </div>
        <div class="stats-cal-wrap">
          <div class="small"><b>ì›”ê°„ ìº˜ë¦°ë”</b> (ì´ë²ˆ ë‹¬, ì¼ë³„ ì„­ì·¨ëŸ‰ ê°•ë„)</div>
          <div id="month-calendar" class="small"></div>
        </div>
      </div>
      <div id="stats-text" class="small" style="margin-top:6px;"></div>
 <!-- ğŸ“Š í†µê³„ ì „ì²´ í™”ë©´ì—ì„œë§Œ ë³´ì´ëŠ” ê¸°ê°„ë³„ ì„¸ë¶€ ê·¸ë˜í”„ ì˜ì—­ -->
  <div id="stats-detail-wrapper" style="display:none; margin-top:10px;">
    <div class="small" style="margin-bottom:6px;">
      ì˜¤ëŠ˜ Â· ìµœê·¼ 7ì¼ Â· ì´ë²ˆ ë‹¬ Â· ì˜¬í•´ê¹Œì§€ì˜ ì¹´í˜ì¸ ì„­ì·¨ëŸ‰ì„
      <b>ê¸°ê°„ ìˆœì„œëŒ€ë¡œ í•œ ë²ˆì—</b> ë³¼ ìˆ˜ ìˆëŠ” ì„¸ë¶€ ê·¸ë˜í”„ì…ë‹ˆë‹¤.
    </div>

    <!-- 1) ì˜¤ëŠ˜ (ì‹œê°„ëŒ€ë³„) -->
    <div class="stats-detail-block">
      <h4>ì˜¤ëŠ˜ (ì‹œê°„ëŒ€ë³„)</h4>
      <div style="height:180px; margin-bottom:6px;">
        <canvas id="stats-chart-day"></canvas>
      </div>
      <div class="small" id="stats-text-day"></div>
    </div>

    <!-- 2) ìµœê·¼ 7ì¼ (ì¼ë³„) -->
    <div class="stats-detail-block">
      <h4>ìµœê·¼ 7ì¼ (ì¼ë³„)</h4>
      <div style="height:180px; margin-bottom:6px;">
        <canvas id="stats-chart-week"></canvas>
      </div>
      <div class="small" id="stats-text-week"></div>
    </div>

    <!-- 3) ì´ë²ˆ ë‹¬ (ì¼ë³„) -->
    <div class="stats-detail-block">
      <h4>ì´ë²ˆ ë‹¬ (ì¼ë³„)</h4>
      <div style="height:180px; margin-bottom:6px;">
        <canvas id="stats-chart-month"></canvas>
      </div>
      <div class="small" id="stats-text-month"></div>
    </div>

    <!-- 4) ì˜¬í•´ (ì›”ë³„) -->
    <div class="stats-detail-block">
      <h4>ì˜¬í•´ (ì›”ë³„)</h4>
      <div style="height:180px; margin-bottom:6px;">
        <canvas id="stats-chart-year"></canvas>
      </div>
      <div class="small" id="stats-text-year"></div>
    </div>
  </div>
</section>

    <!-- 3-2 í˜ˆì¤‘ ì¹´í˜ì¸ -->
    <section class="panel" id="extra-section-blood">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ Â· ìˆ˜ë©´ ì‹œê°„</span>
          <span class="small">ë°˜ê°ê¸° ëª¨ë¸ + í™•ëŒ€/ì¶•ì†Œ + ìˆ˜ë©´ ì‹œê°„ ì¶”ì²œ</span>
        </div>
        <button type="button" class="btn btn-ghost" onclick="openBloodDetail()">ì „ì²´ í™”ë©´</button>
      </div>
      <div class="row">
        <div>
          <label>í‰ì†Œ ì·¨ì¹¨ ì‹œê°„</label>
          <input type="time" id="sleep-time" />
          <div class="small">* ì·¨ì¹¨ ì‹œê°„ì„ ë°”ê¾¸ë©´, í•´ë‹¹ ì‹œì ì˜ ì”ì—¬ ì¹´í˜ì¸ê³¼ ìˆ˜ë©´ ì˜í–¥ ì•ˆë‚´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div>
          <label>ê·¸ë˜í”„ ë³´ê¸° ë²”ìœ„</label>
          <select id="caffeine-range">
            <option value="morning">ì•„ì¹¨ (6~12ì‹œ)</option>
            <option value="school">ë“±êµ~í•˜êµ ì‹œê°„ (6~18ì‹œ)</option>
            <option value="evening">ì €ë…/ë°¤ (18~24ì‹œ)</option>
            <option value="full" selected>í•˜ë£¨ ì „ì²´ (0~24ì‹œ)</option>
          </select>
          <div class="small">* ë²”ìœ„ë¥¼ ë°”ê¾¸ë©´ ê·¸ë˜í”„ë¥¼ í™•ëŒ€Â·ì¶•ì†Œí•´ì„œ ì¶”ì´ë¥¼ ìì„¸íˆ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </div>

      <div style="margin-top:8px; height:230px;">
        <canvas id="caffeine-chart"></canvas>
      </div>
      <div id="sleep-info" style="margin-top:8px; font-size:0.9rem;"></div>
      <!-- ğŸ“ˆ í˜ˆì¤‘ ì¹´í˜ì¸ ì„¸ë¶€ ê·¸ë˜í”„ (ì „ì²´ í™”ë©´ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
      <div id="blood-detail-wrapper" style="display:none; margin-top:10px;">
        <div class="small" style="margin-bottom:6px;">
          ìœ„ì˜ ê·¸ë˜í”„ëŠ” <b>ì˜¤ëŠ˜ í•˜ë£¨</b> ì¤‘ ì„ íƒí•œ ì‹œê°„ëŒ€ë§Œ ë³´ëŠ” ê·¸ë˜í”„ì´ê³ ,<br>
          ì•„ë˜ë¶€í„°ëŠ” <b>ìµœê·¼ 1ì£¼ì¼</b>ê³¼ <b>ì´ë²ˆ ë‹¬</b> ë™ì•ˆì˜
          <b>í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ ì¶”ì´</b>ë¥¼ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ê¸¸ê²Œ ë³´ì—¬ì£¼ëŠ” ì„¸ë¶€ ê·¸ë˜í”„ì…ë‹ˆë‹¤.
        </div>

        <!-- 1) ìµœê·¼ 7ì¼ ì „ì²´ ì¶”ì´ -->
        <div class="stats-detail-block">
          <h4>ìµœê·¼ 7ì¼ í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ ì¶”ì´</h4>
          <div style="height:180px; margin-bottom:6px;">
            <canvas id="caffeine-chart-week"></canvas>
          </div>
          <div class="small" id="caffeine-text-week"></div>
        </div>

        <!-- 2) ì´ë²ˆ ë‹¬ ì „ì²´ ì¶”ì´ -->
        <div class="stats-detail-block">
          <h4>ì´ë²ˆ ë‹¬ í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ ì¶”ì´</h4>
          <div style="height:180px; margin-bottom:6px;">
            <canvas id="caffeine-chart-month"></canvas>
          </div>
          <div class="small" id="caffeine-text-month"></div>
        </div>
      </div>
    </section>

    <!-- 3-3 ë¶€ì‘ìš© -->
    <section class="panel" id="extra-section-effects">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>ë¶€ì‘ìš© ê¸°ë¡ Â· ëŒ€ì²˜ë²• Â· í›„ê¸°</span>
          <span class="small">ìì£¼ ë‚˜íƒ€ë‚˜ëŠ” ì¦ìƒì€ ì•„ì´ì½˜ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì„ íƒ</span>
        </div>
        <button type="button" class="btn btn-ghost" onclick="openEffectsDetail()">ì „ì²´ í™”ë©´</button>
      </div>

      <div class="row">
        <div style="flex:1; min-width:260px;">
          <h3 style="margin:0 0 4px; font-size:0.95rem; color:#065f46;">1) ì£¼ìš” ì¦ìƒ ì„ íƒ</h3>
          <div class="effect-icon-row" id="effect-icons"></div>
          <div id="effect-tips" class="effect-tips" style="display:none;"></div>

          <form id="side-effect-form" style="margin-top:8px;">
            <label>ì¦ìƒ ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="side-effect-notes" placeholder="ì˜ˆ: ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê³ , ì†ì´ ì•½ê°„ ë–¨ë ¸ì–´ìš”."></textarea>
            <label>ë°œìƒ ì‹œê°</label>
            <input type="datetime-local" id="side-effect-time" />
            <div style="margin-top:8px; display:flex; justify-content:flex-end;">
              <button type="submit" class="btn btn-primary">ë¶€ì‘ìš© ê¸°ë¡ ì €ì¥</button>
            </div>
          </form>
        </div>

        <div style="flex:1; min-width:260px;">
<h3 style="margin:0 0 4px; font-size:0.95rem; color:#065f46;">2) ë‚´ ë¶€ì‘ìš© ê¸°ë¡</h3>
<div id="side-effect-list" class="small">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>

<!-- âœ… ì¶”ê°€: ë‚´ ì¹´í˜ì¸ ìœ„í—˜ë„ ìš”ì•½ -->
<div id="risk-indicator-box" class="small" style="margin-top:8px; padding:6px 8px; border-radius:8px; background:#fefce8; border:1px solid #facc15; display:none;">
  <!-- JSì—ì„œ ë‚´ìš©ì´ ì±„ì›Œì§ -->
</div>

<h3 style="margin:10px 0 4px; font-size:0.95rem; color:#065f46;">3) ë‹¤ë¥¸ ì‚¬ëŒ í›„ê¸°</h3>

          <div style="display:flex; gap:6px;">
            <div style="flex:1; min-width:180px;">
              <h4 style="margin:4px 0; font-size:0.9rem; color:#065f46;">í›„ê¸°</h4>
              <div id="peer-stories" class="small"></div>
            </div>
            <div style="flex:1; min-width:180px;">
              <h4 style="margin:4px 0; font-size:0.9rem; color:#065f46;">í•´ê²° ë°©ë²•</h4>
              <div id="peer-solutions" class="small"></div>
            </div>
          </div>
        </div>
      </div>
  <!-- 4) ì„¸ë¶€ í™”ë©´(ì „ì²´ í™”ë©´ ëª¨ë“œì—ì„œë§Œ) : ì¦ìƒë³„ ìƒì„¸ ëª¨ì•„ë³´ê¸° -->
  <div id="effects-detail-advanced"
       style="margin-top:10px; padding-top:8px; border-top:1px dashed #d1fae5; display:none;">
    <h3 style="margin:0 0 4px; font-size:0.95rem; color:#065f46;">
      ğŸ“ ë¶€ì‘ìš© ìƒì„¸ ê¸°ë¡ ëª¨ì•„ë³´ê¸°
    </h3>
    <div class="small" style="color:#047857; margin-bottom:4px;">
      â€˜ì „ì²´ í™”ë©´â€™ìœ¼ë¡œ ë“¤ì–´ì™”ì„ ë•Œ, ë‚´ê°€ ê¸°ë¡í•œ ë¶€ì‘ìš©ì„ ì¦ìƒë³„ë¡œ ëª¨ì•„ ë³´ê³ <br>
      ê° ì¦ìƒì— ë§ëŠ” <b>ëŒ€ì²˜ ë°©ë²•</b>ê³¼ <b>ë‹¤ë¥¸ ì‚¬ëŒ í›„ê¸°</b>ë¥¼ í•¨ê»˜ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
    <div id="effects-detail-body" class="small"></div>
  </div>

    </section>

    <!-- 3-4 ë°°ë„ˆ/ì •ë³´ -->
    <section class="panel" id="extra-section-banner">
      <div class="panel-title">
        <div class="panel-title-left">
          <span>ì¹´í˜ì¸ ì •ë³´ / ì¤„ì´ê¸° ìº í˜ì¸</span>
          <span class="small">ì§€ì‹ì¸ í¬ë¡¤ë§ ê²°ê³¼(íŒŒì¼) ê¸°ë°˜ ì¸ê¸° ìƒí’ˆ + ìº í˜ì¸</span>
        </div>
        <button type="button" class="btn btn-ghost" onclick="openBannerDetail()">ì „ì²´ í™”ë©´</button>
      </div>
      <div class="small">
        ì•„ë˜ í‘œëŠ” <code>popular_products.json</code> íŒŒì¼(ì§€ì‹ì¸ í¬ë¡¤ë§ ì „ì²˜ë¦¬ ê²°ê³¼)ì„ ë¶ˆëŸ¬ì™€ì„œ êµ¬ì„±í•©ë‹ˆë‹¤.
        íŒŒì¼ì´ ì—†ê±°ë‚˜ ì½ê¸°ì— ì‹¤íŒ¨í•˜ë©´, ìƒ˜í”Œ ë°ì´í„°ë¥¼ ëŒ€ì‹  ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
      <div class="banner-cards">

        <!-- ì¢Œì¸¡: ì§€ì‹ì¸ í¬ë¡¤ë§ -->
        <div class="banner-card" style="flex:1.6;">
          <div class="banner-card-title">ğŸ“¦ ì§€ì‹ì¸ ê¸°ë°˜ ìœ ëª… ìŒë£ŒÂ·ì‹í’ˆ ì¹´í˜ì¸</div>
          <div class="small">
            <label style="display:block; margin-bottom:4px;">í‚¤ì›Œë“œ ì…ë ¥ (ì„ íƒ)</label>
            <div class="row" style="align-items:flex-end;">
              <div style="flex:2; min-width:140px;">
                <input type="text" id="naver-keyword-input" placeholder="ì˜ˆ: ì—ë„ˆì§€ ë“œë§í¬, ìº”ì»¤í”¼, ì½œë¼" />
              </div>
              <div style="flex:1; min-width:120px;">
                <button type="button" class="btn btn-outline" id="naver-fetch-btn">
                  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°(ì§€ì‹ì¸ ê¸°ë°˜)
                </button>
              </div>
            </div>
            <div class="small" id="naver-fetch-hint" style="margin-top:4px;">
              * ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê°™ì€ í´ë”ì˜ <b>popular_products.json</b> íŒŒì¼ì„ ì½ì–´ì™€ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
              (íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©)
            </div>
          </div>
          <div class="small" style="margin-top:6px; max-height:220px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.78rem;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:4px; border-bottom:1px solid #a7f3d0;">ìˆœìœ„</th>
                  <th style="text-align:left; padding:4px; border-bottom:1px solid #a7f3d0;">ìƒí’ˆëª…</th>
                  <th style="text-align:left; padding:4px; border-bottom:1px solid #a7f3d0;">ìœ í˜•</th>
                  <th style="text-align:right; padding:4px; border-bottom:1px solid #a7f3d0;">ë“±ì¥ ë¹ˆë„</th>
                  <th style="text-align:right; padding:4px; border-bottom:1px solid #a7f3d0;">ì˜ˆìƒ ì¹´í˜ì¸(mg)</th>
                </tr>
              </thead>
              <tbody id="popular-products-body"></tbody>
            </table>
          </div>
        </div>

        <!-- ìš°ì¸¡: ì¹´í˜ì¸ ì¤„ì´ê¸° ìº í˜ì¸ -->
        <div class="banner-card">
          <div class="banner-card-title">ğŸŒ± ì¹´í˜ì¸ ì¤„ì´ê¸° ìº í˜ì¸/ë°©ë²•</div>
          <ul class="small">
            <li>ì˜¤í›„ 4ì‹œ ì´í›„ ì¹´í˜ì¸ ëŒ€ì‹  ë¬¼Â·ë¬´ì¹´í˜ì¸ í‹° ë§ˆì‹œê¸°</li>
            <li>ì¼ì¼ ìµœëŒ€ ì„­ì·¨ëŸ‰ì„ ì •í•´ë‘ê³  ì•±ì—ì„œ ì´ˆê³¼ ì‹œ ì•Œë¦¼ ë°›ê¸°</li>
            <li>ì¹œêµ¬ë“¤ê³¼ â€œë…¸ì¹´í˜ì¸ ì±Œë¦°ì§€â€ ì£¼ê°„ ìš´ì˜í•˜ê¸°</li>
          </ul>
          <div class="small" style="margin-top:4px;">
            í•™êµÂ·ë³´ê±´ì†ŒÂ·ì§€ìì²´ì—ì„œ ì§„í–‰í•˜ëŠ” <b>ì¹´í˜ì¸ ì¤„ì´ê¸° ìº í˜ì¸</b> ì‚¬ì´íŠ¸ë¥¼ ì—°ê²°í•˜ëŠ” ë²„íŠ¼ì„ ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
<div id="fab-menu-button">ï¼‹</div>
<div id="fab-overlay">
  <div id="fab-menu">
    <button onclick="openIntake()">ğŸ“’ ì¹´í˜ì¸ ê¸°ë¡</button>
    <button onclick="openStatsDetail()">ğŸ“Š ê·¸ë˜í”„/í†µê³„(ì„¸ë¶€)</button>
    <button onclick="showExtraCombined()">ğŸ“š ì¶”ê°€ ê¸°ëŠ¥ ì „ì²´</button>
    <button onclick="showHome()">ğŸ  ê¸°ë³¸ í™”ë©´</button>
  </div>
</div>

<!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="nav-pill" onclick="openIntake()">
      <div class="nav-dot"></div>
      <span>ì˜¤ëŠ˜ ì¹´í˜ì¸ ì„­ì·¨, ë°”ë¡œ ê¸°ë¡í•˜ê¸°</span>
    </button>
  </div>
</nav>

<script>
  const HALF_LIFE_HOURS = 5;
  const DEFAULT_WEIGHT_KG = 60;
  let userProfile = { weightKg: DEFAULT_WEIGHT_KG };
  let RECOMMENDED_MG = Math.round(DEFAULT_WEIGHT_KG * 2.5);
  let MAX_MG = RECOMMENDED_MG * 1.5;

  let intakes = [];
  let sideEffects = [];
  let currentEditId = null;
  let extraDetailMode = null;
  let userProductShortcuts = [];

  const POPULAR_PRODUCTS_SAMPLE = [
    { rank:1, name:"ëª¬ìŠ¤í„° ì—ë„ˆì§€", category:"ìƒ˜í”Œ", count:120, caffeineMg:100 },
    { rank:2, name:"ë ˆë“œë¶ˆ", category:"ìƒ˜í”Œ", count:95, caffeineMg:80 },
    { rank:3, name:"í•«ì‹ìŠ¤", category:"ìƒ˜í”Œ", count:80, caffeineMg:60 },
    { rank:4, name:"ì¡°ì§€ì•„ ì—ë©”ë„ë“œ ë§ˆìš´í‹´", category:"ìƒ˜í”Œ", count:50, caffeineMg:120 },
    { rank:5, name:"ì½”ì¹´ì½œë¼", category:"ìƒ˜í”Œ", count:45, caffeineMg:25 }
  ];

  // ì§€ì‹ì¸/í‘œì¤€ ì •ë³´ë¥¼ ëª¨ì•„ë‘ëŠ” ê°„ë‹¨í•œ ìƒí’ˆ DB
// ì§€ì‹ì¸/í‘œì¤€ ì •ë³´ë¥¼ ëª¨ì•„ë‘ëŠ” ê°„ë‹¨í•œ ìƒí’ˆ DB (ì´ë§ˆíŠ¸24 ê¸°ì¤€ RTD + ì—ë„ˆì§€ë“œë§í¬)
const PRODUCT_DB = [
  /* =======================
   *  ì—ë„ˆì§€ ë“œë§í¬ (ì´ë§ˆíŠ¸24)
   * ======================= */
  {
    keyWords: ["ëª¬ìŠ¤í„°", "ëª¬ìŠ¤í„°ì—ë„ˆì§€", "ëª¬ìŠ¤í„° ì—ë„ˆì§€", "monster", "monster energy"],
    brand: "ëª¬ìŠ¤í„°",
    store: "ì´ë§ˆíŠ¸24",
    name: "ëª¬ìŠ¤í„° ì—ë„ˆì§€ 355ml",
    caffeineMg: 100,
    volumeMl: 355,
    category: "ì—ë„ˆì§€ ë“œë§í¬"
  },
  {
    keyWords: ["í•«ì‹ìŠ¤", "í•«ì‹ìŠ¤ë”í‚¹", "í•«ì‹ìŠ¤ ë”í‚¹", "hot6", "hot six", "the king"],
    brand: "í•«ì‹ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "í•«ì‹ìŠ¤ ë”í‚¹ 355ml",
    caffeineMg: 100,
    volumeMl: 355,
    category: "ì—ë„ˆì§€ ë“œë§í¬"
  },
  {
    keyWords: ["í•«ì‹ìŠ¤", "í•«ì‹ìŠ¤ë”í‚¹", "í•«ì‹ìŠ¤ ë”í‚¹", "hot6", "hot six", "the king"],
    brand: "í•«ì‹ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "í•«ì‹ìŠ¤ ë”í‚¹ 500ml",
    caffeineMg: 140,
    volumeMl: 500,
    category: "ì—ë„ˆì§€ ë“œë§í¬"
  },
  {
    keyWords: ["ë ˆë“œë¶ˆ", "red bull", "redbull"],
    brand: "ë ˆë“œë¶ˆ",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë ˆë“œë¶ˆ 250ml",
    caffeineMg: 62.5,
    volumeMl: 250,
    category: "ì—ë„ˆì§€ ë“œë§í¬"
  },

  /* =======================
   *  ìŠ¤íƒ€ë²…ìŠ¤ RTD (ìº”/ë³´í‹€)
   * ======================= */
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë”ë¸”ìƒ·ë°”ë‹ë¼", "ë”ë¸”ìƒ· ë°”ë‹ë¼", "ë”ë¸”ìƒ·", "ë°”ë‹ë¼ ë”ë¸”ìƒ·"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ë°”ë‹ë¼ 200ml(ìº”/ë³´í‹€)",
    caffeineMg: 140,
    volumeMl: 200,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë”ë¸”ìƒ·ë°”ë‹ë¼", "ë”ë¸”ìƒ· ë°”ë‹ë¼", "ë”ë¸”ìƒ·", "ë°”ë‹ë¼ ë”ë¸”ìƒ·"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ë°”ë‹ë¼ 275ml(ìº”/ë³´í‹€)",
    caffeineMg: 193,
    volumeMl: 275,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë”ë¸”ìƒ·ì—ìŠ¤í”„ë ˆì†Œí¬ë¦¼", "ë”ë¸”ìƒ· ì—ìŠ¤í”„ë ˆì†Œ í¬ë¦¼", "ë”ë¸”ìƒ·í¬ë¦¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ì—ìŠ¤í”„ë ˆì†Œ í¬ë¦¼ 200ml",
    caffeineMg: 103,
    volumeMl: 200,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë”ë¸”ìƒ·ì—ìŠ¤í”„ë ˆì†Œí¬ë¦¼", "ë”ë¸”ìƒ· ì—ìŠ¤í”„ë ˆì†Œ í¬ë¦¼", "ë”ë¸”ìƒ·í¬ë¦¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ì—ìŠ¤í”„ë ˆì†Œ í¬ë¦¼ 275ml",
    caffeineMg: 142,
    volumeMl: 275,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë”ë¸”ìƒ·ëŒì²´", "ë”ë¸”ìƒ· ëŒì²´", "ëŒì²´ ë”ë¸”ìƒ·"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ëŒì²´ 275ml",
    caffeineMg: 193,
    volumeMl: 275,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "íŒŒì´í¬í”Œë ˆì´ìŠ¤ë¡œìŠ¤íŠ¸ë¸”ë™", "íŒŒì´í¬ í”Œë ˆì´ìŠ¤ ë¡œìŠ¤íŠ¸ ë¸”ë™", "íŒŒì´í¬í”Œë ˆì´ìŠ¤", "íŒŒì´í¬ í”Œë ˆì´ìŠ¤"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ íŒŒì´í¬ í”Œë ˆì´ìŠ¤ ë¡œìŠ¤íŠ¸ ë¸”ë™ 200ml",
    caffeineMg: 107,
    volumeMl: 200,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "íŒŒì´í¬í”Œë ˆì´ìŠ¤ë¡œìŠ¤íŠ¸ë¸”ë™", "íŒŒì´í¬ í”Œë ˆì´ìŠ¤ ë¡œìŠ¤íŠ¸ ë¸”ë™", "íŒŒì´í¬í”Œë ˆì´ìŠ¤", "íŒŒì´í¬ í”Œë ˆì´ìŠ¤"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ íŒŒì´í¬ í”Œë ˆì´ìŠ¤ ë¡œìŠ¤íŠ¸ ë¸”ë™ 275ml",
    caffeineMg: 147,
    volumeMl: 275,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì¹´í˜ë² ë¡œë‚˜ë¸”ë™", "ì¹´í˜ ë² ë¡œë‚˜ ë¸”ë™", "ë² ë¡œë‚˜"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì¹´í˜ ë² ë¡œë‚˜ ë¸”ë™ 275ml",
    caffeineMg: 151,
    volumeMl: 275,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì˜¤ë¦¬ì§€ë‚ ", "ì˜¤ë¦¬ì§€ë„", "starbucks original"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì˜¤ë¦¬ì§€ë‚  281ml",
    caffeineMg: 102,
    volumeMl: 281,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ëª¨ì¹´", "ìŠ¤íƒ€ë²…ìŠ¤ ëª¨ì¹´"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ëª¨ì¹´ 281ml",
    caffeineMg: 82,
    volumeMl: 281,
    category: "RTD ì»¤í”¼(ìº”/ë³´í‹€)"
  },

  /* =======================
   *  ìŠ¤íƒ€ë²…ìŠ¤ ì»µ ì œí’ˆ
   * ======================= */
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë°”ë‹ë¼", "ì»µë°”ë‹ë¼", "ìŠ¤íƒ€ë²…ìŠ¤ ì»µ ë°”ë‹ë¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë°”ë‹ë¼ 200ml(ì»µ)",
    caffeineMg: 92,
    volumeMl: 200,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì¹´í˜ë¼ë–¼", "ì¹´í˜ ë¼ë–¼", "ë¼ë–¼", "ì»µë¼ë–¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì¹´í˜ë¼ë–¼ 200ml(ì»µ)",
    caffeineMg: 92,
    volumeMl: 200,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì¹´í˜ë¼ë–¼", "ì¹´í˜ ë¼ë–¼", "ë¼ë–¼", "ì»µë¼ë–¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì¹´í˜ë¼ë–¼ 320ml(ì»µ)",
    caffeineMg: 147,
    volumeMl: 320,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì¹´í˜ëª¨ì¹´", "ì¹´í˜ ëª¨ì¹´", "ëª¨ì¹´", "ì»µëª¨ì¹´"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì¹´í˜ëª¨ì¹´ 320ml(ì»µ)",
    caffeineMg: 147,
    volumeMl: 320,
    category: "ì»µ ì»¤í”¼"
  },

  /* =======================
   *  ìŠ¤íƒ€ë²…ìŠ¤ PET/í«
   * ======================= */
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ë°€í¬í‹°", "ìŠ¤íƒ€ë²…ìŠ¤ ë°€í¬í‹°"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ë°€í¬í‹° 325ml(PET)",
    caffeineMg: 116,
    volumeMl: 325,
    category: "í‹°/ë°€í¬í‹°"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì…€ë ‰íŠ¸ë°”ë‹ë¼ë¼ë–¼", "ì…€ë ‰íŠ¸ ë°”ë‹ë¼ ë¼ë–¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì…€ë ‰íŠ¸ ë°”ë‹ë¼ ë¼ë–¼ 300ml(PET)",
    caffeineMg: 133,
    volumeMl: 300,
    category: "RTD ì»¤í”¼(PET)"
  },
  {
    keyWords: ["ìŠ¤íƒ€ë²…ìŠ¤", "ì…€ë ‰íŠ¸ì¹´í˜ë¼ë–¼", "ì…€ë ‰íŠ¸ ì¹´í˜ ë¼ë–¼"],
    brand: "ìŠ¤íƒ€ë²…ìŠ¤",
    store: "ì´ë§ˆíŠ¸24",
    name: "ìŠ¤íƒ€ë²…ìŠ¤ ì…€ë ‰íŠ¸ ì¹´í˜ ë¼ë–¼ 300ml(PET)",
    caffeineMg: 133,
    volumeMl: 300,
    category: "RTD ì»¤í”¼(PET)"
  },

  /* =======================
   *  ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€ (ì»µ)
   * ======================= */
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ì—ìŠ¤í”„ë ˆì†Œë¼ë–¼", "ì—ìŠ¤í”„ë ˆì†Œ ë¼ë–¼"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ì—ìŠ¤í”„ë ˆì†Œ ë¼ë–¼ 250ml(ì»µ)",
    caffeineMg: 110,
    volumeMl: 250,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ë¡œì–´ìŠˆê±°ì—ìŠ¤í”„ë ˆì†Œë¼ë–¼", "ë¡œì–´ìŠˆê±° ì—ìŠ¤í”„ë ˆì†Œ ë¼ë–¼", "ë¡œìŠˆê±°"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ë¡œì–´ìŠˆê±° ì—ìŠ¤í”„ë ˆì†Œ ë¼ë–¼ 250ml(ì»µ)",
    caffeineMg: 115,
    volumeMl: 250,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ëª¨ì¹´í”„ë ˆì†Œ", "ëª¨ì¹´ í”„ë ˆì†Œ"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ëª¨ì¹´í”„ë ˆì†Œ 250ml(ì»µ)",
    caffeineMg: 95,
    volumeMl: 250,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ì¹´ë¼ë©œë”¥í”„ë ˆì†Œ", "ì¹´ë¼ë©œ ë”¥í”„ë ˆì†Œ"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ì¹´ë¼ë©œ ë”¥í”„ë ˆì†Œ 250ml(ì»µ)",
    caffeineMg: 100,
    volumeMl: 250,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ìŠ¤ëª¨í‚¤ë¡œìŠ¤í‹°ë“œë¼ë–¼", "ìŠ¤ëª¨í‚¤ ë¡œìŠ¤í‹°ë“œ ë¼ë–¼"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ìŠ¤ëª¨í‚¤ ë¡œìŠ¤í‹°ë“œ ë¼ë–¼ 250ml(ì»µ)",
    caffeineMg: 113,
    volumeMl: 250,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ë§ˆë‹¤ê°€ìŠ¤ì¹´ë¥´ë°”ë‹ë¼ë¹ˆë¼ë–¼", "ë§ˆë‹¤ê°€ìŠ¤ì¹´ë¥´ ë°”ë‹ë¼ë¹ˆ ë¼ë–¼", "ë°”ë‹ë¼ë¹ˆ ë¼ë–¼"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ë§ˆë‹¤ê°€ìŠ¤ì¹´ë¥´ ë°”ë‹ë¼ë¹ˆ ë¼ë–¼ 325ml(ì»µ)",
    caffeineMg: 105,
    volumeMl: 325,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ë²¨ì§€ì—„ì‡¼ì½œë¼ëª¨ì¹´", "ë²¨ì§€ì—„ ì‡¼ì½œë¼ ëª¨ì¹´"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ë²¨ì§€ì—„ ì‡¼ì½œë¼ ëª¨ì¹´ 325ml(ì»µ)",
    caffeineMg: 125,
    volumeMl: 325,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ëŒì²´ë¼ë–¼", "ëŒì²´ ë¼ë–¼"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ëŒì²´ ë¼ë–¼ 325ml(ì»µ)",
    caffeineMg: 130,
    volumeMl: 325,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ì‹œê·¸ë‹ˆì²˜ë“œë¦½ë¼ë–¼", "ì‹œê·¸ë‹ˆì²˜ ë“œë¦½ ë¼ë–¼"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ì‹œê·¸ë‹ˆì²˜ ë“œë¦½ ë¼ë–¼ 325ml(ì»µ)",
    caffeineMg: 160,
    volumeMl: 325,
    category: "ì»µ ì»¤í”¼"
  },
  {
    keyWords: ["ë§¤ì¼", "ë°”ë¦¬ìŠ¤íƒ€", "ì½œë“œë¸Œë£¨ë¸”ë™", "ì½œë“œ ë¸Œë£¨ ë¸”ë™", "ì½œë“œë¸Œë£¨"],
    brand: "ë§¤ì¼ ë°”ë¦¬ìŠ¤íƒ€",
    store: "ì´ë§ˆíŠ¸24",
    name: "ë°”ë¦¬ìŠ¤íƒ€ ì½œë“œë¸Œë£¨ ë¸”ë™ 325ml(ì»µ)",
    caffeineMg: 165,
    volumeMl: 325,
    category: "ì½œë“œë¸Œë£¨/ë¸”ë™"
  }
];

// ===== [SYLLABLE_MATCH_UTIL] ìƒí’ˆëª… ìŒì ˆ(ê¸€ì) ë‹¨ìœ„ ë§¤ì¹­ ìœ í‹¸ =====
function normalizeKorText(text) {
  return (text || '')
    .toLowerCase()
    .replace(/\s+/g, '')               // ê³µë°± ì œê±°
    .replace(/[^0-9ê°€-í£a-z]/g, '');    // í•œê¸€/ìˆ«ì/ì˜ë¬¸ ì™¸ ì œê±°
}

// baseStr: DBì— ìˆëŠ” ìƒí’ˆëª…ì´ë‚˜ í‚¤ì›Œë“œ
// ocrText: OCRë¡œ ì¶”ì¶œëœ ì „ì²´ í…ìŠ¤íŠ¸
// ë°˜í™˜ê°’: 0~1 (1ì´ë©´ baseStrì˜ ëª¨ë“  ê¸€ìê°€ ocrTextì— ë“±ì¥)
function syllableMatchScore(baseStr, ocrText) {
  const base = normalizeKorText(baseStr);
  const txt  = normalizeKorText(ocrText);
  if (!base || !txt) return 0;

  let matched = 0;
  for (const ch of base) {
    if (txt.includes(ch)) matched++;
  }
  return matched / base.length;
}

// OCR í…ìŠ¤íŠ¸ì™€ ê°€ì¥ ì˜ ë§ëŠ” ìƒí’ˆ(DB)ì„ ì°¾ëŠ” í•¨ìˆ˜
function findProductBySyllables(ocrText) {
  let bestProduct = null;
  let bestScore = 0;

  for (const p of PRODUCT_DB) {
    const candidates = [p.name, ...(p.keyWords || [])];

    for (const cand of candidates) {
      const score = syllableMatchScore(cand, ocrText);

      // 1. ëª¨ë“  ê¸€ìê°€ í¬í•¨ëœ "ì™„ì „ë§¤ì¹­"ì´ë©´ ë°”ë¡œ ì±„íƒ
      if (score === 1 && normalizeKorText(cand).length > 0) {
        return p;
      }

      // 2. ì™„ì „ë§¤ì¹­ì€ ì•„ë‹ˆì§€ë§Œ ê½¤ ë†’ì€ ìœ ì‚¬ë„(ì˜ˆ: 0.7 ì´ìƒ)ë¥¼ ê°€ì§„ ê²½ìš°
      if (score > bestScore && score >= 0.7) {
        bestScore = score;
        bestProduct = p;
      }
    }
  }

  return bestProduct;  // ì—†ìœ¼ë©´ null
}

const PRODUCT_SHORTCUT_DEFS = [
  {
    id: 'starbucks_ame_tall',
    icon: 'â˜•',
    label: 'ìŠ¤íƒ€ë²…ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ í†¨',
    caffeineMg: 150,
    volume: '355ml (í†¨)',
    defaultAmountNote: '1ì”'
  },
  {
    id: 'paiks_iced_tea',
    icon: 'ğŸ§Š',
    label: 'ë¹½ë‹¤ë°© ì•„ì´ìŠ¤í‹°',
    caffeineMg: 21,
    volume: '24oz',
    defaultAmountNote: '1ì”'
  },
  {
    id: 'monster_355',
    icon: 'âš¡',
    label: 'ëª¬ìŠ¤í„° ì—ë„ˆì§€ 355ml',
    caffeineMg: 100,
    volume: '355ml',
    defaultAmountNote: '1ìº”'
  }
];

const EFFECT_DEFS = [
  { id:'palpitation', icon:'ğŸ’“', label:'ì‹¬ì¥ ë‘ê·¼ê±°ë¦¼', tip:'ì¼ì‹œì ìœ¼ë¡œ ì¹´í˜ì¸ ì„­ì·¨ë¥¼ ì¤‘ë‹¨í•˜ê³ , ê¹Šê²Œ ìˆ¨ì„ ì‰¬ë©° íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”. ì¦ìƒì´ ê³„ì†ë˜ë©´ ë³´í˜¸ìÂ·ì˜ì‚¬ì™€ ìƒì˜í•´ì•¼ í•©ë‹ˆë‹¤.' },
  { id:'insomnia', icon:'ğŸŒ™', label:'ë¶ˆë©´ì¦', tip:'ëŠ¦ì€ ì˜¤í›„ ì´í›„ ì¹´í˜ì¸ ì„­ì·¨ë¥¼ í”¼í•˜ê³ , ì·¨ì¹¨ 1ì‹œê°„ ì „ì—ëŠ” ìŠ¤ë§ˆíŠ¸í°Â·ë°ì€ í™”ë©´ì„ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.' },
  { id:'anxiety', icon:'ğŸ˜°', label:'ì´ˆì¡°/ë¶ˆì•ˆ', tip:'ë¬¼ì„ ì¶©ë¶„íˆ ë§ˆì‹œê³ , ì§§ì€ ì‚°ì±…Â·ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ëª¸ì„ í’€ì–´ ì£¼ì„¸ìš”. ë¶ˆì•ˆì´ ì‹¬í•˜ë©´ ìƒë‹´ ì„ ìƒë‹˜Â·ì „ë¬¸ì˜ì™€ ìƒì˜í•˜ì„¸ìš”.' },
  { id:'headache', icon:'ğŸ¤•', label:'ë‘í†µ', tip:'ë¬¼ì„ ë§ˆì‹œê³ , ì¡°ìš©í•˜ê³  ì–´ë‘ìš´ ê³³ì—ì„œ ì ê¹ ëˆˆì„ ê°ê³  ì‰¬ëŠ” ê²ƒì´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ìƒì— ì§€ì¥ì„ ì¤„ ì •ë„ë¼ë©´ ë³‘ì› ì§„ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
  { id:'stomach', icon:'ğŸ¤¢', label:'ì†ì“°ë¦¼/ë©”ìŠ¤êº¼ì›€', tip:'ê³µë³µ ì¹´í˜ì¸ì„ í”¼í•˜ê³ , ê°€ë³ê²Œ ì‹ì‚¬ë¥¼ í•œ ë’¤ ë”°ëœ»í•œ ë¬¼ì„ ì¡°ê¸ˆì”© ë§ˆì‹œì„¸ìš”. êµ¬í† Â·ë³µí†µì´ ì‹¬í•˜ë©´ ë³´í˜¸ìì—ê²Œ ë°”ë¡œ ì•Œë¦¬ì„¸ìš”.' },
  { id:'tremor', icon:'ğŸ¤²', label:'ì†ë°œ ë–¨ë¦¼', tip:'ì†ì´ë‚˜ ë°œì´ ë–¨ë¦´ ë•ŒëŠ” ì¹´í˜ì¸ ì„­ì·¨ë¥¼ ì¤‘ë‹¨í•˜ê³ , ë¬¼ì„ ë§ˆì‹œë©° í¸í•œ ìì„¸ë¡œ íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”. ë–¨ë¦¼ì´ ì˜¤ë˜ ê°€ê±°ë‚˜ ì‹¬í•˜ë©´ ë³´í˜¸ìÂ·ì˜ì‚¬ì™€ ìƒì˜í•´ì•¼ í•©ë‹ˆë‹¤.' },
  { id:'etc', icon:'â“', label:'ê¸°íƒ€', tip:'ìì‹ ì´ ëŠë‚€ ì¦ìƒì„ ìì„¸íˆ ì ì–´ ë‘ë©´ ì˜ì‚¬Â·ë³´í˜¸ìê°€ ìƒíƒœë¥¼ íŒŒì•…í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.' }
];


  const PEER_STORIES = [
    {
      id: 'palpitation',
      icon: 'ğŸ’“',
      label: 'ì‹¬ì¥ ë‘ê·¼ê±°ë¦¼',
      story: 'ê³ 3 í•™ìƒ / ì—ë„ˆì§€ ë“œë§í¬ 2ìº”(ì•½ 300mg)ì„ ë¹ ë¥´ê²Œ ë§ˆì‹  ë’¤ ì‹¬ì¥ì´ ë¹¨ë¦¬ ë›°ê³  ë¶ˆì•ˆê°ì„ ëŠë‚Œ.',
      solution: 'ì´í›„ ì˜¤í›„ 4ì‹œ ì´í›„ì—ëŠ” ì¹´í˜ì¸ì„ ë§ˆì‹œì§€ ì•Šê³ , í•˜ë£¨ 1ì”ë§Œ ì²œì²œíˆ ë§ˆì‹œëŠ” ìŠµê´€ìœ¼ë¡œ ë°”ê¾¸ì ì¦ìƒì´ ê±°ì˜ ì‚¬ë¼ì§.'
    },
    {
      id: 'insomnia',
      icon: 'ğŸŒ™',
      label: 'ë¶ˆë©´ì¦',
      story: 'ì¤‘3 í•™ìƒ / ì‹œí—˜ ê¸°ê°„ë§ˆë‹¤ ìº”ì»¤í”¼ì™€ ì½œë¼ë¥¼ í•¨ê»˜ ë§ˆì‹œë‹¤ê°€ ìƒˆë²½ 3ì‹œê¹Œì§€ ì ì´ ì˜¤ì§€ ì•ŠëŠ” ë‚ ì´ ê³„ì†ë¨.',
      solution: 'ìˆ˜ë©´ì¼ê¸°ë¥¼ ì“°ë©° ì¹´í˜ì¸ ìŒë£ŒëŠ” ì˜¤í›„ 2ì‹œ ì´ì „ê¹Œì§€ë§Œ ë§ˆì‹œê³ , ì €ë…ì—ëŠ” ë¬¼Â·ìš°ìœ ë¡œ ë°”ê¾¸ì 11~12ì‹œ ì‚¬ì´ì— ì ë“¤ ìˆ˜ ìˆê²Œ ë¨.'
    },
    {
      id: 'stomach',
      icon: 'ğŸ¤¢',
      label: 'ì†ì“°ë¦¼',
      story: 'ê³ 1 í•™ìƒ / ì•„ì¹¨ì„ ê±°ë¥´ê³  ë¼ë–¼ë§Œ ë§ˆì…¨ë‹¤ê°€ ì†ì´ ë©”ìŠ¤ê»ê³  ì“°ë¦° ëŠë‚Œì´ ë°˜ë³µë¨.',
      solution: 'â€œê³µë³µì— ì¹´í˜ì¸ ê¸ˆì§€â€ ì›ì¹™ì„ ì„¸ìš°ê³ , ë¹µÂ·ë°”ë‚˜ë‚˜ ë“±ì„ ë¨¼ì € ë¨¹ì€ ë’¤ ë¼ë–¼ë¥¼ ë§ˆì‹œì ì†ì´ í›¨ì”¬ í¸ì•ˆí•´ì§.'
    }
  ];

// ===== ë¶€ì‘ìš© ê°€ì¤‘ì¹˜ ê¸°ë°˜ 'ì¹´í˜ì¸ ìœ„í—˜ë„ ì ìˆ˜' ê³„ì‚° =====
// ì„¤ë¬¸ ë¶„ì„ì—ì„œ ë„ì¶œí•œ ê°€ì¤‘ì¹˜ë¥¼ effectId ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘
const EFFECT_WEIGHTS = {
  palpitation: 0.83,  // ì‹¬ì¥ ë‘ê·¼ê±°ë¦¼
  insomnia:    1.00,  // ë¶ˆë©´ì¦
  headache:    0.33,  // ë‘í†µ
  stomach:     0.33,  // ì†ì“°ë¦¼/ë©”ìŠ¤êº¼ì›€
  anxiety:     0.17,  // ì´ˆì¡°/ë¶ˆì•ˆ
  tremor:      0.08,  // ì†ë°œ ë–¨ë¦¼
  etc:         0.08   // ê¸°íƒ€(ê²½ë¯¸í•œ ì¦ìƒ)
};

const MAX_EFFECT_SCORE =
  EFFECT_WEIGHTS.palpitation +
  EFFECT_WEIGHTS.insomnia +
  EFFECT_WEIGHTS.headache +
  EFFECT_WEIGHTS.stomach +
  EFFECT_WEIGHTS.anxiety +
  EFFECT_WEIGHTS.tremor +
  EFFECT_WEIGHTS.etc;

// sideEffects ë°°ì—´(ë‚´ ê¸°ë¡ ì „ì²´)ì„ ê¸°ì¤€ìœ¼ë¡œ
// "ì–´ë–¤ ì¦ìƒì„ í•œ ë²ˆì´ë¼ë„ ê²ªì—ˆëŠ”ì§€"ë¥¼ ëª¨ì•„ì„œ ì ìˆ˜ ê³„ì‚°
function computeUserEffectScore() {
  if (!sideEffects || sideEffects.length === 0) return 0;

  // effectIdë³„ë¡œ í•œ ë²ˆì´ë¼ë„ ë‚˜íƒ€ë‚¬ìœ¼ë©´ 1ë¡œ ì²˜ë¦¬
  const used = new Set();
  sideEffects.forEach(s => {
    if (s.effectId && EFFECT_WEIGHTS[s.effectId] !== undefined) {
      used.add(s.effectId);
    }
  });

  let score = 0;
  used.forEach(id => {
    score += EFFECT_WEIGHTS[id];
  });

  return score; // 0 ~ MAX_EFFECT_SCORE ì‚¬ì´ ê°’
}

// 0~100ì  í™˜ì‚° + ìœ„í—˜êµ°(ì €/ì¤‘/ê³ ) + "ìƒìœ„ ëª‡ % ëŠë‚Œ" í…ìŠ¤íŠ¸ ìƒì„±
function buildRiskIndicatorText() {
  const rawScore = computeUserEffectScore();
  if (rawScore <= 0) {
    return {
      visible: false,
      html: 'ì§€ê¸ˆê¹Œì§€ ê¸°ë¡ëœ ë¶€ì‘ìš©ì´ ì—†ì–´ì„œ, ì¹´í˜ì¸ ë¯¼ê°ë„ ìœ„í—˜ë„ëŠ” ë§¤ìš° ë‚®ì€ ìƒíƒœì…ë‹ˆë‹¤.'
    };
  }

  const normalized = (rawScore / MAX_EFFECT_SCORE) * 100; // 0~100ì 

  let level = 'ì €ìœ„í—˜';
  let percentText = 'í•˜ìœ„ 50% ì´ìƒ(ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì „í•œ í¸)';
  let emoji = 'ğŸŸ¢';

  if (normalized >= 60 && normalized < 80) {
    level = 'ì¤‘ìœ„í—˜';
    percentText = 'ëŒ€ëµ ìƒìœ„ 30~40% êµ¬ê°„ì´ë¼ ê½¤ ë¯¼ê°í•œ í¸ì…ë‹ˆë‹¤.';
    emoji = 'ğŸŸ ';
  } else if (normalized >= 80) {
    level = 'ê³ ìœ„í—˜';
    percentText = 'ëŒ€ëµ ìƒìœ„ 20% ì•ˆì— ë“¤ì–´ê°€ëŠ” ìˆ˜ì¤€ì´ë¼, ì¹´í˜ì¸ì— ìƒë‹¹íˆ ë¯¼ê°í•œ í¸ì…ë‹ˆë‹¤.';
    emoji = 'ğŸ”´';
  }

  // â€œìƒìœ„ ëª‡ %ë‹ˆê¹ ì¡°ì‹¬í•˜ì…ˆâ€ ëŠë‚Œìœ¼ë¡œ ë©”ì‹œì§€ êµ¬ì„±
  const html = `
    <b>${emoji} ë‚´ ì¹´í˜ì¸ ë¯¼ê°ë„ ìœ„í—˜ë„ ìš”ì•½</b><br>
    Â· ë¶€ì‘ìš© ì ìˆ˜: <b>${normalized.toFixed(1)}ì  / 100ì </b> (${level})<br>
    Â· ${percentText}<br><br>
    ìµœê·¼ì— ê¸°ë¡í•œ ë¶€ì‘ìš©(ë‘ê·¼ê±°ë¦¼, ë¶ˆë©´, ë‘í†µ, ì†ì“°ë¦¼, ë¶ˆì•ˆ ë“±)ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•œ ê°’ì´ì—ìš”.<br>
    ëŠ¦ì€ ì €ë…Â·ì‹œí—˜ ê¸°ê°„ì—ëŠ” ì¹´í˜ì¸ ì„­ì·¨ëŸ‰ê³¼ ì‹œê°„ëŒ€ë¥¼ ì¡°ê¸ˆ ë” ì¡°ì‹¬í•´ì„œ ì¡°ì ˆí•´ ë³´ëŠ” ê±¸ ì¶”ì²œí•©ë‹ˆë‹¤.
  `;

  return {
    visible: true,
    html
  };
}

// DOMì— ì‹¤ì œë¡œ ë¿Œë ¤ì£¼ëŠ” í•¨ìˆ˜
function renderRiskIndicator() {
  const box = document.getElementById('risk-indicator-box');
  if (!box) return;

  const { visible, html } = buildRiskIndicatorText();
  if (!visible) {
    box.style.display = 'none';
    box.innerHTML = '';
    return;
  }

  box.style.display = 'block';
  box.innerHTML = html;
}



  function isSameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
  }
  function formatDateTimeLocal(date) {
    const pad = n => String(n).padStart(2,'0');
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }
  function formatDateTimeView(date) {
    const pad = n => String(n).padStart(2,'0');
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function loadData() {
    try {
      intakes = JSON.parse(localStorage.getItem('intakes') || '[]');
      sideEffects = JSON.parse(localStorage.getItem('sideEffects') || '[]');
const storedShortcuts = JSON.parse(localStorage.getItem('userProductShortcuts') || '[]');
      if (Array.isArray(storedShortcuts)) {
        userProductShortcuts = storedShortcuts;
      } else {
        userProductShortcuts = [];
      }

      const storedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      if (storedProfile && typeof storedProfile.weightKg === 'number' && storedProfile.weightKg > 0) {
        userProfile.weightKg = storedProfile.weightKg;
      }
    } catch (e) {
      intakes = [];
      sideEffects = [];
    }
    updateRecommendedFromProfile();
  }
  function saveData() {
    localStorage.setItem('intakes', JSON.stringify(intakes));
    localStorage.setItem('sideEffects', JSON.stringify(sideEffects));
  }
function saveUserProductShortcuts() {
  localStorage.setItem('userProductShortcuts', JSON.stringify(userProductShortcuts));
}
  function saveUserProfile() {
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
  }
  function updateRecommendedFromProfile() {
    const w = userProfile.weightKg || DEFAULT_WEIGHT_KG;
    RECOMMENDED_MG = Math.round(w * 2.5);
    MAX_MG = RECOMMENDED_MG * 1.5;
    const wtInput = document.getElementById('weight-kg');
    if (wtInput) wtInput.value = w;
    const label = document.getElementById('cup-mark-label');
    if (label) label.textContent = `ì¼ì¼ ê¶Œì¥ ì„­ì·¨ëŸ‰ (ì•½ ${RECOMMENDED_MG} mg)`;
  }

  function updateEditSelect() {
    const sel = document.getElementById('edit-intake-select');
    if (!sel) return;
    const items = intakes.slice().sort((a,b)=>new Date(b.takenAt) - new Date(a.takenAt));
    if (!items.length) {
      sel.innerHTML = '<option value="">ìˆ˜ì •í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</option>';
      return;
    }
    const pad = n => String(n).padStart(2,'0');
    sel.innerHTML = items.map(i => {
      const d = new Date(i.takenAt);
      const label = `[${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}] ${i.productName} (${i.caffeineMg}mg)`;
      return `<option value="${i.id}">${label}</option>`;
    }).join('');
  }

  function updateTodaySummary() {
    const today = new Date();
    let total = 0;
    let count = 0;
    intakes.forEach(i => {
      const d = new Date(i.takenAt);
      if (isSameDay(d, today)) {
        total += i.caffeineMg;
        count++;
      }
    });

    const summaryDiv = document.getElementById('today-summary');
    if (summaryDiv) {
      summaryDiv.innerHTML = `
        <div class="stat-row"><span>ì˜¤ëŠ˜ ì´ ì„­ì·¨ëŸ‰</span><span><b>${total.toFixed(0)} mg</b></span></div>
        <div class="stat-row"><span>ê¸°ë¡ëœ ì„­ì·¨ íšŸìˆ˜</span><span>${count}íšŒ</span></div>
      `;
    }

    const cupFill = document.getElementById('cup-fill');
    const cupText = document.getElementById('cup-text');
    const cupShell = document.getElementById('cup-gauge');
    const cupBody = document.querySelector('.cup-body');
    if (cupFill && cupText) {
      let percent = MAX_MG > 0 ? (total / MAX_MG) * 100 : 0;
      if (percent > 100) percent = 100;
      if (percent < 0) percent = 0;
      cupFill.style.height = `${percent}%`;
      cupText.textContent = `${total.toFixed(0)} mg`;

      if (cupShell && total > RECOMMENDED_MG && !window._cupAlertShown) {
        window._cupAlertShown = true;
        const showOnce = () => {
          cupShell.classList.add('alert');
          if (cupBody) cupBody.classList.add('shake');
          setTimeout(() => {
            cupShell.classList.remove('alert');
            if (cupBody) cupBody.classList.remove('shake');
          }, 2000);
        };
        showOnce();
        setTimeout(showOnce, 2500);
      }
    }
  }

  // ===== OCR í•¨ìˆ˜ (all_ocr ìˆ˜ì •.htmlì—ì„œ ê°€ì ¸ì™€ í†µí•©) =====
  async function runOCR(file) {
    const apiKey = "K87918974988957";  // â˜… ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” ë³¸ì¸ í‚¤ë¡œ êµì²´

   const formData = new FormData();
  formData.append("apikey", apiKey);
  formData.append("language", "kor");          // í•œê¸€ OCR
  formData.append("isOverlayRequired", "false");
  formData.append("OCREngine", "2");           // â˜…â˜… í•µì‹¬: ì—”ì§„2 ì‚¬ìš© ì„¤ì • â˜…â˜…
  formData.append("file", file);

  const response = await fetch("https://api.ocr.space/parse/image", {
    method: "POST",
    body: formData,
  });

  const result = await response.json();
  if (result.ParsedResults && result.ParsedResults.length > 0) {
    return result.ParsedResults[0].ParsedText;
  }
  return "";
}
// [OCR í•¨ìˆ˜ ë - ì—”ì§„2 ì‚¬ìš© ë²„ì „]


  function guessFromFilename(name) {
    // íŒŒì¼ëª… ì „ì²´ë¥¼ ì†Œë¬¸ìë¡œ
    name = name.toLowerCase();

    // 1) ë¨¼ì € PRODUCT_DBì—ì„œ ì •í™•íˆ ì•„ëŠ” ìƒí’ˆì¸ì§€ í™•ì¸
    const dbHit = PRODUCT_DB.find(p =>
      p.keyWords.some(k => name.includes(k.toLowerCase()))
    );
    if (dbHit) {
      return {
        mg: dbHit.caffeineMg,
        label: `${dbHit.name} (${dbHit.volumeMl}ml, ì•½ ${dbHit.caffeineMg}mg)`
      };
    }

    // 2) DBì— ì—†ìœ¼ë©´ ê¸°ì¡´ ê·œì¹™ ì‚¬ìš©
    if (name.includes('coffee') || name.includes('cafe') || name.includes('latte') || name.includes('americano')) {
      return { mg: 80, label: 'ì»¤í”¼(ì¶”ì •)' };
    }
    if (name.includes('energy')) {
      return { mg: 120, label: 'ì—ë„ˆì§€ ë“œë§í¬(ì¶”ì •)' };
    }
    if (name.includes('tea') || name.includes('green')) {
      return { mg: 40, label: 'ì°¨/í‹°(ì¶”ì •)' };
    }
    if (name.includes('cola') || name.includes('coke')) {
      return { mg: 30, label: 'ì½œë¼/íƒ„ì‚°ìŒë£Œ(ì¶”ì •)' };
    }
    if (name.includes('choco') || name.includes('chocolate')) {
      return { mg: 30, label: 'ì´ˆì½œë¦¿/ë””ì €íŠ¸(ì¶”ì •)' };
    }
    if (name.includes('snack') || name.includes('cookie') || name.includes('cake')) {
      return { mg: 20, label: 'ê°„ì‹/ê³¼ì(ì¶”ì •)' };
    }
    return null;
  }

function guessFromProductName(text) {
  const name = (text || '').toLowerCase();
  if (!name) return null;

  // 1) ë¨¼ì € OCRì™€ ë™ì¼í•œ ìŒì ˆ ë§¤ì¹­ìœ¼ë¡œ DB ê²€ìƒ‰
  const dbHit = findProductBySyllables(text);
  if (dbHit) {
    return {
      mg: dbHit.caffeineMg,
      label: `${dbHit.name} (${dbHit.volumeMl}ml, ì•½ ${dbHit.caffeineMg}mg)`
    };
  }

  // 2) PRODUCT_DB í‚¤ì›Œë“œì— ì§ì ‘ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
  const dbDirect = PRODUCT_DB.find(p =>
    p.keyWords.some(k => name.includes(k.toLowerCase()))
  );
  if (dbDirect) {
    return {
      mg: dbDirect.caffeineMg,
      label: `${dbDirect.name} (${dbDirect.volumeMl}ml, ì•½ ${dbDirect.caffeineMg}mg)`
    };
  }

  // 3) DBì— ì—†ìœ¼ë©´ ê¸°ì¡´ ê·œì¹™ ì‚¬ìš©
  if (name.includes('ì•„ë©”ë¦¬ì¹´ë…¸') || name.includes('americano')) {
    return { mg: 100, label: 'ì•„ë©”ë¦¬ì¹´ë…¸(ì¶”ì •)' };
  }
  if (name.includes('ì—ìŠ¤í”„ë ˆì†Œ') || name.includes('espresso')) {
    return { mg: 80, label: 'ì—ìŠ¤í”„ë ˆì†Œ(ì¶”ì •)' };
  }
  if (name.includes('ë¼ë–¼') || name.includes('latte')) {
    return { mg: 75, label: 'ë¼ë–¼/ìš°ìœ ì»¤í”¼(ì¶”ì •)' };
  }
  if (name.includes('ì½œë¼') || name.includes('cola') || name.includes('coke')) {
    return { mg: 30, label: 'ì½œë¼/íƒ„ì‚°ìŒë£Œ(ì¶”ì •)' };
  }
  if (name.includes('ì—ë„ˆì§€') || name.includes('ëª¬ìŠ¤í„°') || name.includes('ë ˆë“œë¶ˆ') || name.includes('energy')) {
    return { mg: 120, label: 'ì—ë„ˆì§€ ë“œë§í¬(ì¶”ì •)' };
  }
  if (name.includes('í‹°') || name.includes('tea') || name.includes('ë…¹ì°¨') || name.includes('ê·¸ë¦°í‹°')) {
    return { mg: 40, label: 'ì°¨/í‹°(ì¶”ì •)' };
  }
  if (name.includes('ì´ˆì½œë¦¿') || name.includes('ì´ˆì½”') || name.includes('choco') || name.includes('chocolate')) {
    return { mg: 30, label: 'ì´ˆì½œë¦¿/ë””ì €íŠ¸(ì¶”ì •)' };
  }
  if (name.includes('ì¿ í‚¤') || name.includes('cookie') || name.includes('ì¼€ì´í¬') || name.includes('cake')) {
    return { mg: 20, label: 'ê°„ì‹/ê³¼ì(ì¶”ì •)' };
  }

  return null;
}

  // ---- ì§€ì‹ì¸ JSON + ìƒ˜í”Œ í•„í„°ë§ & ë Œë”ë§ ----
  function filterPopularProducts(keyword) {
    const kw = (keyword || '').trim().toLowerCase();
    if (!kw) return POPULAR_PRODUCTS_SAMPLE;
    return POPULAR_PRODUCTS_SAMPLE.filter(p =>
      p.name.toLowerCase().includes(kw) ||
      (p.category || '').toLowerCase().includes(kw)
    );
  }

  function renderPopularProducts(list) {
    const tbody = document.getElementById('popular-products-body');
    if (!tbody) return;
    if (!list.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:4px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ë°”ê¾¸ê±°ë‚˜ ë¹„ì›Œì„œ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(item => `
      <tr>
        <td style="padding:4px; border-bottom:1px solid #d1fae5;">${item.rank ?? ''}</td>
        <td style="padding:4px; border-bottom:1px solid #d1fae5;">${item.name}</td>
        <td style="padding:4px; border-bottom:1px solid #d1fae5;">${item.category ?? ''}</td>
        <td style="padding:4px; border-bottom:1px solid #d1fae5; text-align:right;">${item.count ?? ''}</td>
        <td style="padding:4px; border-bottom:1px solid #d1fae5; text-align:right;">${item.caffeineMg ?? '-'}</td>
      </tr>
    `).join('');
  }

  // popular_products.json(ì§€ì‹ì¸ í¬ë¡¤ë§ ê²°ê³¼)ì„ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜
  async function loadPopularProducts(keyword) {
    try {
      const res = await fetch('popular_products.json'); // ê°™ì€ í´ë”ì— ìœ„ì¹˜
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const all = await res.json(); // [{rank,name,category,count,caffeineMg}, ...]
      const kw = (keyword || '').trim();
      if (!kw) return all;
      return all.filter(p =>
        (p.name && p.name.includes(kw)) ||
        (p.category && p.category.includes(kw))
      );
    } catch (err) {
      console.error('popular_products.json ë¡œë“œ ì‹¤íŒ¨, ìƒ˜í”Œë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.', err);
      return filterPopularProducts(keyword);
    }
  }

document.addEventListener('change', function(e) {
  // â˜… íŒŒì¼ ì„ íƒ ì‹œ: íŒŒì¼ëª…ì´ ì•„ë‹ˆë¼ OCR ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì œí’ˆëª…/ì¹´í˜ì¸ ì¶”ì •
  if (e.target.id === 'photo-input') {
    const file = e.target.files[0];
    if (!file) return;

    const caffeineInput = document.getElementById('caffeine-mg');
    const productInput  = document.getElementById('product-name');
    const hint          = document.getElementById('photo-hint');

    if (hint) {
      hint.textContent = 'ì´ë¯¸ì§€ì—ì„œ ë¼ë²¨ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
    }

    // 1) OCR ì‹¤í–‰ â†’ í…ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì œí’ˆëª… / ì¹´í˜ì¸ ì–‘ ì¶”ì •
    runOCR(file).then(text => {
      const rawText = (text || '').trim();

      if (!rawText) {
        // OCR ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°: ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œë§Œ íŒŒì¼ëª… ì‚¬ìš©
        const fileGuess = guessFromFilename(file.name || '');
        if (fileGuess && caffeineInput && !caffeineInput.value) {
          caffeineInput.value = fileGuess.mg;
        }
        if (productInput && !productInput.value && fileGuess) {
          productInput.value = fileGuess.label;
        }
        if (hint) {
          hint.innerHTML = 'OCRë¡œ ë¼ë²¨ í…ìŠ¤íŠ¸ë¥¼ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ' +
                           (fileGuess
                             ? `íŒŒì¼ëª…ì„ ê¸°ì¤€ìœ¼ë¡œ <b>${fileGuess.label}</b>ë¡œ ì¶”ì •í•˜ì—¬ ì•½ <b>${fileGuess.mg}</b> mgë¡œ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
                             : 'ì œí’ˆëª… ë˜ëŠ” ì¹´í˜ì¸ ì–‘ì„ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        }
        return;
      }

      // 2) OCR í…ìŠ¤íŠ¸ì—ì„œ ì œí’ˆëª… í›„ë³´(ì²« ë²ˆì§¸ ì˜ë¯¸ ìˆëŠ” ì¤„) ë½‘ê¸°
      const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      const firstLine = lines[0] || rawText;
      if (productInput && !productInput.value) {
        productInput.value = firstLine;
      }

      // 3) OCR í…ìŠ¤íŠ¸ì—ì„œ "ìˆ«ì + mg" í˜•ì‹ ì§ì ‘ ì¶”ì¶œ (ì˜ˆ: 100mg)
      let mgFromLabel = null;
      const mgMatch = rawText.match(/(\d+)\s*mg/i);
      if (mgMatch) {
        mgFromLabel = parseInt(mgMatch[1], 10);
      }

      // 4) OCR ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìƒí’ˆ DBì™€ ìŒì ˆ ë‹¨ìœ„ë¡œ ëŒ€ì¡°
      let dbProduct = findProductBySyllables(rawText);   // â˜… [SYLLABLE_MATCH_UTIL] ì‚¬ìš©
      let guess = null;

      if (dbProduct) {
        // DBì— ìˆëŠ” ìƒí’ˆê³¼ ìŒì ˆ ë§¤ì¹­ì´ ëœ ê²½ìš°
        guess = {
          mg: dbProduct.caffeineMg,
          label: `${dbProduct.name} (${dbProduct.volumeMl}ml, ì•½ ${dbProduct.caffeineMg}mg)`
        };

        // ì œí’ˆëª… ì¹¸ì„ DB ìƒí’ˆëª…ìœ¼ë¡œ ë³´ì •
        if (productInput && !productInput.value) {
          productInput.value = dbProduct.name;
        }
      } else if (!mgFromLabel) {
        // DBì—ì„œë„ ëª» ì°¾ê³ , mg ìˆ«ìë„ ì—†ì„ ë•Œ â†’ ê¸°ì¡´ ì œí’ˆëª… ê¸°ë°˜ ì¶”ì • ì‚¬ìš©
        guess = guessFromProductName(firstLine || rawText);
      }

      // 5) ì¹´í˜ì¸ ì…ë ¥ì¹¸ ì±„ìš°ê¸° (ì´ë¯¸ ì§ì ‘ ì…ë ¥í•œ ê°’ì´ ì—†ì„ ë•Œë§Œ ìë™ ì…ë ¥)
      if (caffeineInput && !caffeineInput.value) {
        if (mgFromLabel) {
          caffeineInput.value = mgFromLabel;
        } else if (guess) {
          caffeineInput.value = guess.mg;
        }
      }

      // 6) ì•ˆë‚´ë¬¸ êµ¬ì„±
      if (hint) {
        let msg = 'OCRë¡œ ë¼ë²¨ í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í–ˆìŠµë‹ˆë‹¤.';
        if (firstLine) {
          msg += ` (ì˜ˆ: "<b>${firstLine}</b>")`;
        }
        if (mgFromLabel) {
          msg += ` ë¼ë²¨ì—ì„œ <b>${mgFromLabel}mg</b> ë¬¸êµ¬ë¥¼ ì°¾ì•„ ì¹´í˜ì¸ ì–‘ì„ ìë™ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.`;
        } else if (dbProduct && guess) {
          msg += ` ì¸ì‹ëœ í…ìŠ¤íŠ¸ì™€ ìƒí’ˆ DBë¥¼ ìŒì ˆ ë‹¨ìœ„ë¡œ ëŒ€ì¡°í•˜ì—¬ <b>${guess.label}</b>ë¡œ íŒë‹¨í•˜ê³ , ì•½ <b>${guess.mg}</b> mgë¡œ ìë™ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.`;
        } else if (guess) {
          msg += ` ë¼ë²¨ì— ë‚˜íƒ€ë‚œ ì œí’ˆëª…ì„ ë°”íƒ•ìœ¼ë¡œ <b>${guess.label}</b>ë¡œ ì¶”ì •í•˜ì—¬ ì•½ <b>${guess.mg}</b> mgë¡œ ìë™ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.`;
        } else {
          msg += ' ë‹¤ë§Œ ì¹´í˜ì¸ ì–‘/ì¢…ë¥˜ë¥¼ ì •í™•íˆ ì°¾ì§€ ëª»í•´, ì œí’ˆëª… ë˜ëŠ” ì¹´í˜ì¸ ì–‘ì€ ì§ì ‘ í™•ì¸í•´ ì£¼ì„¸ìš”.';
        }
        hint.innerHTML = msg;
      }

    }).catch(err => {
      console.error('OCR ì—ëŸ¬:', err);
      const caffeineInput = document.getElementById('caffeine-mg');
      const productInput  = document.getElementById('product-name');
      const hint          = document.getElementById('photo-hint');

      // OCRë„ ì‹¤íŒ¨í•˜ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œë§Œ íŒŒì¼ëª… ì¶”ì • ì‚¬ìš©
      const fileGuess = guessFromFilename(file.name || '');
      if (fileGuess && caffeineInput && !caffeineInput.value) {
        caffeineInput.value = fileGuess.mg;
      }
      if (productInput && !productInput.value && fileGuess) {
        productInput.value = fileGuess.label;
      }
      if (hint) {
        hint.innerHTML =
          'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ' +
          (fileGuess
            ? `íŒŒì¼ëª…ì„ ê¸°ì¤€ìœ¼ë¡œ <b>${fileGuess.label}</b>ë¡œ ì¶”ì •í•˜ì—¬ ì•½ <b>${fileGuess.mg}</b> mgë¡œ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
            : 'ì œí’ˆëª… ë˜ëŠ” ì¹´í˜ì¸ ì–‘ì„ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      }
    });

    return; // ì´í•˜ ë‹¤ë¥¸ change í•¸ë“¤ëŸ¬ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šë„ë¡ ì—¬ê¸°ì„œ ì¢…ë£Œ
  }

  // â˜… ë‚˜ë¨¸ì§€ change í•¸ë“¤ëŸ¬ë“¤ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€
  if (e.target.id === 'period-select') {
    updateStats();
  }
  if (e.target.id === 'sleep-time' || e.target.id === 'caffeine-range') {
    updateCaffeineGraph();
  }
  if (e.target.id === 'weight-kg') {
    const val = parseFloat(e.target.value || '0');
    if (!isNaN(val) && val > 0) {
      userProfile.weightKg = val;
      updateRecommendedFromProfile();
      saveUserProfile();
      updateTodaySummary();
      updateStats();
      updateCaffeineGraph();
    }
  }
});

  document.addEventListener('click', function(e) {
    if (e.target.id === 'now-btn') {
      const input = document.getElementById('intake-time');
      if (input) input.value = formatDateTimeLocal(new Date());
      return;
    }
    if (e.target.id === 'guess-from-name-btn') {
      const nameInput = document.getElementById('product-name');
      const caffeineInput = document.getElementById('caffeine-mg');
      const hint = document.getElementById('photo-hint');
      const text = nameInput ? nameInput.value.trim() : '';
      if (!text) {
        alert('ë¨¼ì € ì œí’ˆ/ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      const guessed = guessFromProductName(text);
      if (!guessed) {
        alert('í•´ë‹¹ ì œí’ˆëª…ì—ì„œëŠ” ì¹´í˜ì¸ ì–‘ì„ ì¶”ì •í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (caffeineInput.value) {
        if (!confirm('ì´ë¯¸ ì…ë ¥ëœ ì¹´í˜ì¸ ì–‘ì´ ìˆìŠµë‹ˆë‹¤. ì œí’ˆëª… ê¸°ì¤€ ì¶”ì •ê°’ìœ¼ë¡œ ë®ì–´ì“¸ê¹Œìš”?')) return;
      }
      caffeineInput.value = guessed.mg;
      if (hint) {
        hint.innerHTML = `ì œí’ˆëª…ì„ ë°”íƒ•ìœ¼ë¡œ <b>${guessed.label}</b>ë¡œ ì¸ì‹í•˜ì—¬ ì•½ <b>${guessed.mg}</b> mgë¡œ ìë™ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ìƒí’ˆê³¼ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
      }
      return;
    }
    if (e.target.id === 'edit-mode-btn') {
      const box = document.getElementById('edit-tools');
      if (!box) return;
      const visible = box.style.display !== 'none';
      box.style.display = visible ? 'none' : 'block';
      if (!visible) updateEditSelect();
      return;
    }
    // âœ… ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì•„ì´ì½˜ - ì‚¬ìš©ì ì •ì˜ ì¶”ê°€
    if (e.target.id === 'product-shortcut-add-btn') {
      const nameInput   = document.getElementById('product-shortcut-name');
      const cafInput    = document.getElementById('product-shortcut-caffeine');
      const volInput    = document.getElementById('product-shortcut-volume');
      const iconInput   = document.getElementById('product-shortcut-icon');

      const name = nameInput ? nameInput.value.trim() : '';
      const mg   = cafInput ? parseFloat(cafInput.value || '0') : 0;
      const vol  = volInput ? volInput.value.trim() : '';
      const icon = iconInput ? iconInput.value.trim() : '';

      if (!name || isNaN(mg) || mg <= 0) {
        alert('ë©”ë‰´ ì´ë¦„ê³¼ ì¹´í˜ì¸ ì–‘(mg)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      userProductShortcuts.push({
        id: 'user_' + Date.now(),
        icon: icon || 'â­',
        label: name,
        caffeineMg: mg,
        volume: vol,
        defaultAmountNote: '1ì”'
      });
      saveUserProductShortcuts();
      renderProductShortcuts();

      if (nameInput) nameInput.value = '';
      if (cafInput) cafInput.value = '';
      if (volInput) volInput.value = '';
      if (iconInput) iconInput.value = '';

      alert('ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì•„ì´ì½˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      return;
    }
    // âœ… ìì£¼ ë§ˆì‹œëŠ” ë©”ë‰´ ì•„ì´ì½˜ ì„ íƒ ì‹œ, ê¸°ë¡ í¼ ìë™ ì±„ìš°ê¸°
    const pChip = e.target.closest && e.target.closest('.product-shortcut-chip');
    if (pChip) {
      const all = getAllProductShortcuts();
      const def = all.find(p => p.id === pChip.dataset.id);
      if (!def) return;

      const nameInput   = document.getElementById('product-name');
      const cafInput    = document.getElementById('caffeine-mg');
      const amountInput = document.getElementById('amount-note');
      const catSelect   = document.getElementById('category');
      const hint        = document.getElementById('product-shortcut-hint');

      if (nameInput)   nameInput.value   = def.label;
      if (cafInput)    cafInput.value    = def.caffeineMg;
      if (amountInput) amountInput.value = def.defaultAmountNote || '1ì”';
      if (catSelect)   catSelect.value   = 'drink';

      if (hint) {
        hint.innerHTML =
          `ì„ íƒí•œ ì•„ì´ì½˜ì„ <b>${def.label}</b> (${def.volume || ''}, ì•½ ${def.caffeineMg}mg)ë¡œ ì¸ì‹í•˜ì—¬ ` +
          `<b>ì œí’ˆëª… Â· ì¹´í˜ì¸ ì–‘ Â· ì„­ì·¨ëŸ‰ ë©”ëª¨</b>ì— ê°’ì„ ì±„ì› ìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.`;
      }

      // ì‹œê° ì…ë ¥ì´ ë¹„ì–´ ìˆìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ
      const intakeTime = document.getElementById('intake-time');
      if (intakeTime && !intakeTime.value) {
        intakeTime.value = formatDateTimeLocal(new Date());
      }

      return;
    }


    if (e.target.id === 'load-intake-btn') {
      const sel = document.getElementById('edit-intake-select');
      if (!sel || !sel.value) {
        alert('ìˆ˜ì •í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      const id = sel.value;
      const intake = intakes.find(i => String(i.id) === id);
      if (!intake) {
        alert('ì„ íƒí•œ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      document.getElementById('product-name').value = intake.productName || '';
      document.getElementById('amount-note').value = intake.amountNote || '';
      document.getElementById('caffeine-mg').value = intake.caffeineMg;
      document.getElementById('intake-time').value = formatDateTimeLocal(new Date(intake.takenAt));
      document.getElementById('meal-timing').value = intake.mealTiming || 'AFTER';
      document.getElementById('category').value = intake.category || 'drink';
      currentEditId = intake.id;
      const submitBtn = document.getElementById('submit-intake-btn');
      if (submitBtn) submitBtn.textContent = 'ìˆ˜ì • ë‚´ìš© ì €ì¥';
      const cupText = document.getElementById('today-cup-text');
      if (cupText) cupText.textContent = 'ì„ íƒí•œ ê¸°ë¡ì„ ìˆ˜ì •í•œ ë’¤ â€œìˆ˜ì • ë‚´ìš© ì €ì¥â€ì„ ëˆ„ë¥´ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.';
      return;
    }

    if (e.target.closest && e.target.closest('.drag-hint')) {
      showExtraCombined();
      return;
    }

    const chip = e.target.closest && e.target.closest('.effect-chip');
    if (chip) {
      document.querySelectorAll('.effect-chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      const def = EFFECT_DEFS.find(d=>d.id===chip.dataset.id);
      const tipsDiv = document.getElementById('effect-tips');
      if (def && tipsDiv) {
        tipsDiv.style.display = 'block';
        tipsDiv.textContent = def.tip + ' (ì‹¬í•˜ê±°ë‚˜ ë°˜ë³µë˜ë©´ ë°˜ë“œì‹œ ë³´í˜¸ìÂ·ì „ë¬¸ê°€ì—ê²Œ ì•Œë ¤ì•¼ í•©ë‹ˆë‹¤.)';
      }
      return;
    }

    // ì§€ì‹ì¸ ê¸°ë°˜ popular_products.json ë¡œë“œ ë²„íŠ¼
    if (e.target.id === 'naver-fetch-btn') {
      const input = document.getElementById('naver-keyword-input');
      const hint = document.getElementById('naver-fetch-hint');
      const keyword = input ? input.value : '';

      loadPopularProducts(keyword)
        .then(list => {
          renderPopularProducts(list);
          if (hint) {
            hint.textContent =
              'popular_products.json(ì§€ì‹ì¸ í¬ë¡¤ë§ ê²°ê³¼)ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í•œ ëª©ë¡ì…ë‹ˆë‹¤. ' +
              'íŒŒì¼ì´ ì—†ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
          }
        })
        .catch(err => {
          console.error(err);
          renderPopularProducts(filterPopularProducts(keyword));
          if (hint) {
            hint.textContent = 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ëŒ€ì‹  í‘œì‹œí•©ë‹ˆë‹¤.';
          }
        });
      return;
    }
  });
    
// ===== í¼ ì œì¶œ ê³µí†µ ì²˜ë¦¬ (ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡ + ë¶€ì‘ìš© ê¸°ë¡) =====

document.addEventListener('submit', function(e) {
  if (e.target.id === 'intake-form') {
    e.preventDefault();

    const caffeinePerUnit = parseFloat(
      document.getElementById('caffeine-mg').value || '0'
    );
    if (isNaN(caffeinePerUnit) || caffeinePerUnit <= 0) {
      alert('ì¹´í˜ì¸ ì–‘ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const productName = document.getElementById('product-name').value.trim() || 'ë¯¸ì§€ì •';
    const amountNoteRaw = document.getElementById('amount-note').value || '';
    const amountNote = amountNoteRaw.trim();

    let count = 1;
    if (amountNote) {
      const pure = amountNote.replace(',', '.').trim();
      if (!isNaN(parseFloat(pure))) {
        count = parseFloat(pure);
      } else {
        const m = amountNote.match(/(\d+(?:[.,]\d+)?)/);
        if (m) {
          count = parseFloat(m[1].replace(',', '.'));
        }
      }
    }
    if (!isFinite(count) || count <= 0) count = 1;

    const caffeineMg = caffeinePerUnit * count;

    const timeStr = document.getElementById('intake-time').value;
    if (!timeStr) {
      alert('ì„­ì·¨ ì‹œê°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    const mealTiming = document.getElementById('meal-timing').value;
    const category = document.getElementById('category').value;
    const takenAtIso = new Date(timeStr).toISOString();

    const submitBtn = document.getElementById('submit-intake-btn');
    const cupText  = document.getElementById('today-cup-text');
    const isEdit   = currentEditId !== null;

    if (!isEdit) {
      intakes.push({
        id: Date.now(),
        productName,
        amountNote,
        caffeineMg,
        takenAt: takenAtIso,
        mealTiming,
        category
      });
    } else {
      const idx = intakes.findIndex(i => i.id === currentEditId);
      if (idx !== -1) {
        intakes[idx].productName = productName;
        intakes[idx].amountNote  = amountNote;
        intakes[idx].caffeineMg  = caffeineMg;
        intakes[idx].takenAt     = takenAtIso;
        intakes[idx].mealTiming  = mealTiming;
        intakes[idx].category    = category;
      }
      currentEditId = null;
      if (submitBtn) submitBtn.textContent = 'ê¸°ë¡ ì €ì¥';
      if (cupText) {
        cupText.textContent =
          'ì»µ ì´ë¯¸ì§€ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„­ì·¨ ê¸°ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
      }
    }

    saveData();
    updateTodaySummary();
    updateStats();
    updateCaffeineGraph();
    updateEditSelect();
    renderStatsDetail();
    renderBloodDetail();
    e.target.reset();

    if (isEdit) {
      alert('ì„ íƒí•œ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      alert('ì¹´í˜ì¸ ì„­ì·¨ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    showHome();
    return;
  }
});

  let statsChart = null;
  // ğŸ“Š ì„¸ë¶€ í™”ë©´(ì˜¤ëŠ˜/7ì¼/ì›”/ì—°)ìš© ì°¨íŠ¸ë“¤ ì €ì¥ìš©
  let statsDetailCharts = {};

  // ê¸°ê°„ë³„ ë¼ë²¨/ë°ì´í„°/í…ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ë§Œë“¤ì–´ ì£¼ëŠ” ê³µí†µ ìœ í‹¸
  function getStatsData(period) {
    const now = new Date();
    let labels = [];
    let data = [];
    let explain = '';
    let extra = '';

    if (period === 'day') {
      // ì˜¤ëŠ˜: ì‹œê°„ëŒ€ë³„
      labels = Array.from({ length: 24 }, (_, i) => `${i}ì‹œ`);
      data = new Array(24).fill(0);
      intakes.forEach(i => {
        const d = new Date(i.takenAt);
        if (isSameDay(d, now)) data[d.getHours()] += i.caffeineMg;
      });
      explain = 'ì˜¤ëŠ˜ ì‹œê°„ëŒ€ë³„ ì¹´í˜ì¸ ì„­ì·¨ëŸ‰ì…ë‹ˆë‹¤.';
    } else if (period === 'week') {
      // ìµœê·¼ 7ì¼: ì¼ë³„
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        days.push(d);
      }
      labels = days.map(d => `${d.getMonth() + 1}/${d.getDate()}`);
      data = new Array(7).fill(0);
      intakes.forEach(i => {
        const d = new Date(i.takenAt);
        days.forEach((day, idx) => {
          if (isSameDay(d, day)) data[idx] += i.caffeineMg;
        });
      });
      explain = 'ìµœê·¼ 7ì¼ ë™ì•ˆì˜ ì¼ë³„ ì´ ì„­ì·¨ëŸ‰ì…ë‹ˆë‹¤.';
      const totalWeek = data.reduce((a, b) => a + b, 0);
      extra = ` / í•˜ë£¨ í‰ê· : <b>${(totalWeek / 7).toFixed(1)} mg</b>`;
    } else if (period === 'month') {
      // ì´ë²ˆ ë‹¬: ë‚ ì§œë³„
      const y = now.getFullYear();
      const m = now.getMonth();
      const lastDay = new Date(y, m + 1, 0).getDate();
      labels = Array.from({ length: lastDay }, (_, i) => `${m + 1}/${i + 1}`);
      data = new Array(lastDay).fill(0);
      intakes.forEach(i => {
        const d = new Date(i.takenAt);
        if (d.getFullYear() === y && d.getMonth() === m) {
          data[d.getDate() - 1] += i.caffeineMg;
        }
      });
      explain = 'ì´ë²ˆ ë‹¬ ë™ì•ˆì˜ ë‚ ì§œë³„ ì´ ì„­ì·¨ëŸ‰ì…ë‹ˆë‹¤.';
      const totalMonth = data.reduce((a, b) => a + b, 0);
      const daysInMonth = labels.length || 1;
      extra = ` / í•˜ë£¨ í‰ê· : <b>${(totalMonth / daysInMonth).toFixed(1)} mg</b>`;
    } else {
      // ì˜¬í•´: ì›”ë³„
      labels = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
      data = new Array(12).fill(0);
      const y = now.getFullYear();
      intakes.forEach(i => {
        const d = new Date(i.takenAt);
        if (d.getFullYear() === y) data[d.getMonth()] += i.caffeineMg;
      });
      explain = 'ì˜¬í•´ ì›”ë³„ ì´ ì„­ì·¨ëŸ‰ì…ë‹ˆë‹¤.';
    }

    const total = data.reduce((a, b) => a + b, 0);
    const avg = data.length ? total / data.length : 0;
    const { weightData, ageData } = buildPeerDataPair(period, labels);

return { now, labels, data, explain, extra, total, avg, ageData };

  }


  function buildPeerDataPair(period, labels) {
    // 26ëª… ë°ì´í„° (ì´ mg / ì‹œê°„ëŒ€)
    const peerRaw = [
      {mg:200, times:["16:00-18:00"]},
      {mg:200, times:["16:00-18:00"]},
      {mg:0,   times:[]},
      {mg:200, times:["20:00-22:00"]},
      {mg:200, times:["8:00-10:00","10:00-12:00","12:00-14:00","14:00-16:00","20:00-22:00","22:00-24:00"]},
      {mg:600, times:["12:00-14:00","22:00-24:00"]},
      {mg:200, times:["8:00-10:00","20:00-22:00"]},
      {mg:0,   times:["20:00-22:00","22:00-24:00"]},
      {mg:200, times:["14:00-16:00"]},
      {mg:0,   times:[]},
      {mg:1000, times:["12:00-14:00","20:00-22:00","22:00-24:00"]},
      {mg:200, times:["10:00-12:00","12:00-14:00","14:00-16:00"]},
      {mg:0,   times:[]},
      {mg:200, times:["14:00-16:00","16:00-18:00"]},
      {mg:200, times:["12:00-14:00"]},
      {mg:0,   times:["10:00-12:00"]},
      {mg:200, times:["20:00-22:00"]},
      {mg:0,   times:[]},
      {mg:200, times:["20:00-22:00","22:00-24:00"]},
      {mg:0,   times:[]},
      {mg:0,   times:[]},
      {mg:200, times:["12:00-14:00"]},
      {mg:200, times:["20:00-22:00"]},
      {mg:0,   times:[]},
      {mg:200, times:["18:00-20:00"]},
      {mg:1000, times:["8:00-10:00","12:00-14:00","16:00-18:00","20:00-22:00","22:00-24:00"]}
    ];

    // ì‹œê°„ëŒ€ë³„ mg í‰ê·  ê³„ì‚° (0~23ì‹œ)
    const hourAvg = new Array(24).fill(0);
    const hourCnt = new Array(24).fill(0);

    peerRaw.forEach(p =>{
      p.times.forEach(t => {
        const [s,e] = t.split("-");
        const sh = parseInt(s.split(":")[0]);
        const eh = parseInt(e.split(":")[0]);
        const eachMg = p.mg / p.times.length; // ì‹œê°„ë¸”ë¡ë³„ ë¶„ë°°

        for (let h = sh; h < eh; h++){
          hourAvg[h] += eachMg;
          hourCnt[h] += 1;
        }
      });
    });

    for (let h=0; h<24; h++){
      if(hourCnt[h]>0) hourAvg[h] = hourAvg[h] / hourCnt[h];
    }

    // periodë³„ ë ˆì´ë¸”ì— ë§ì¶° í‰ê·  ì¶œë ¥
    const ageData = labels.map(label=>{
      if(label.includes("ì‹œ")){
        const h = parseInt(label.replace("ì‹œ",""));
        return hourAvg[h] || 0;
      }
      return 0;
    });

    return { ageData };
  }

  function updateStats() {
    const select = document.getElementById('period-select');
    if (!select) return;

    const period = select.value;
    const {
      now,
      labels,
      data,
      explain,
      extra,
      total,
      avg,
      weightData,
      ageData
    } = getStatsData(period);

    const textDiv = document.getElementById('stats-text');
    if (textDiv) {
    textDiv.innerHTML =
  `ì´ ì„­ì·¨ëŸ‰: <b>${total.toFixed(0)} mg</b>, í‰ê· : <b>${avg.toFixed(1)} mg</b>${extra}` +
  `<br>${explain}` +
  `<br>ì—°í•œ ë…¹ìƒ‰ ë§‰ëŒ€ëŠ” <b>ë‚˜ì˜ ì„­ì·¨ëŸ‰</b>, ì ì„  íšŒìƒ‰ ì‹¤ì„ ì€ <b>ë™ì¼ ë‚˜ì´ í‰ê· </b>ì˜ ê°’ì…ë‹ˆë‹¤.`;
    }

    const canvas = document.getElementById('stats-chart');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      if (!statsChart) {
        statsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'line',
                label: 'ë™ì¼ ë‚˜ì´ í‰ê· ',
                data: ageData,
                tension: 0.3,
                borderColor: 'rgba(156,163,175,0.95)',
                backgroundColor: 'rgba(156,163,175,0.03)',
                borderWidth: 2,
                borderDash: [6, 4],
                pointRadius: 0,
                order: 1
              },
              {
                type: 'bar',
                label: 'ë‚´ ì„­ì·¨ëŸ‰ (mg)',
                data,
                backgroundColor: 'rgba(34,197,94,0.45)',
                borderColor: 'rgba(22,163,74,0.95)',
                borderWidth: 1,
                order: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      } else {
        statsChart.data.labels = labels;
        statsChart.data.datasets[0].data = weightData;
        statsChart.data.datasets[1].data = ageData;
        statsChart.data.datasets[2].data = data;
        statsChart.update();
      }
    }

    // ì›”ê°„ ìº˜ë¦°ë”ëŠ” ê¸°ì¡´ì²˜ëŸ¼ ìœ ì§€ (monthì¼ ë•Œë§Œ data ë„˜ê¸°ê¸°)
    renderMonthCalendar(now, period === 'month' ? data : []);
  }

  // ğŸ“Š í†µê³„ ì „ì²´ í™”ë©´(ì„¸ë¶€ ëª¨ë“œ)ì—ì„œ 4ê°œ ê¸°ê°„ ê·¸ë˜í”„ë¥¼ í•œ ë²ˆì— ë Œë”ë§
  function renderStatsDetail() {
    const wrapper = document.getElementById('stats-detail-wrapper');
    if (!wrapper || wrapper.style.display === 'none') return;

    const configs = [
      { period: 'day',   canvasId: 'stats-chart-day',   textId: 'stats-text-day' },
      { period: 'week',  canvasId: 'stats-chart-week',  textId: 'stats-text-week' },
      { period: 'month', canvasId: 'stats-chart-month', textId: 'stats-text-month' },
      { period: 'year',  canvasId: 'stats-chart-year',  textId: 'stats-text-year' }
    ];

    configs.forEach(cfg => {
      const canvas = document.getElementById(cfg.canvasId);
      const textDiv = document.getElementById(cfg.textId);
      if (!canvas || !textDiv) return;

      const {
        labels,
        data,
        explain,
        extra,
        total,
        avg,
        weightData,
        ageData
      } = getStatsData(cfg.period);

      textDiv.innerHTML =
        `ì´ ì„­ì·¨ëŸ‰: <b>${total.toFixed(0)} mg</b>, í‰ê· : <b>${avg.toFixed(1)} mg</b>${extra}` +
        `<br>${explain}`;

      const ctx = canvas.getContext('2d');

      if (!statsDetailCharts[cfg.period]) {
        // ìµœì´ˆ ìƒì„±
        statsDetailCharts[cfg.period] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'line',
                label: 'ë™ì¼ ë‚˜ì´ í‰ê· ',
                data: ageData,
                tension: 0.3,
                borderColor: 'rgba(156,163,175,0.95)',
                backgroundColor: 'rgba(156,163,175,0.03)',
                borderWidth: 2,
                borderDash: [6, 4],
                pointRadius: 0,
                order: 1
              },
              {
                type: 'bar',
                label: 'ë‚´ ì„­ì·¨ëŸ‰ (mg)',
                data,
                backgroundColor: 'rgba(34,197,94,0.45)',
                borderColor: 'rgba(22,163,74,0.95)',
                borderWidth: 1,
                order: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: {
              legend: { display: false } // ì„¸ë¶€ í™”ë©´ì—ì„œëŠ” ë²”ë¡€ ê°ì¶”ê¸° (ê³µê°„ ì ˆì•½)
            }
          }
        });
      } else {
        // ì´ë¯¸ ìˆëŠ” ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const chart = statsDetailCharts[cfg.period];
        chart.data.labels = labels;
        chart.data.datasets[0].data = weightData;
        chart.data.datasets[1].data = ageData;
        chart.data.datasets[2].data = data;
        chart.update();
      }
    });
  }

  function renderMonthCalendar(now, dataForMonth) {
    const cal = document.getElementById('month-calendar');
    if (!cal) return;
    const y = now.getFullYear();
    const m = now.getMonth();
    const lastDay = new Date(y,m+1,0).getDate();
    const firstWeekday = new Date(y,m,1).getDay();
    const weekdays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

    let data = dataForMonth;
    if (data.length !== lastDay) {
      data = new Array(lastDay).fill(0);
      intakes.forEach(i=>{
        const d = new Date(i.takenAt);
        if (d.getFullYear()===y && d.getMonth()===m) data[d.getDate()-1]+=i.caffeineMg;
      });
    }
    const maxVal = data.length ? Math.max(...data) : 0;

    let html = '<div class="calendar-grid">';
    weekdays.forEach(w=>{
      html += `<div class="calendar-day-header">${w}</div>`;
    });
    for (let i=0;i<firstWeekday;i++) html += '<div class="calendar-day"></div>';

    for (let day=1; day<=lastDay; day++) {
      const idx = day-1;
      const val = data[idx] || 0;
      let bg = '#e5f7ef';
      if (maxVal>0 && val>0) {
        const ratio = val/maxVal;
        const light = 90 - Math.round(35*ratio);
        bg = `hsl(140,60%,${light}%)`;
      }
      const has = val>0;
      html += `<div class="calendar-day${has?' has-intake':''}" style="background:${bg};">${day}</div>`;
    }
    html += '</div><div class="calendar-legend">ìˆ«ìì™€ ìƒ‰ì´ ì§„í• ìˆ˜ë¡ í•´ë‹¹ ë‚ ì§œì˜ ì¹´í˜ì¸ ì„­ì·¨ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤.</div>';
    cal.innerHTML = html;
  }

  let caffeineChart = null;
  let caffeineWeekChart  = null;
  let caffeineMonthChart = null;

  function caffeineLevelAt(time) {
    let total = 0;
    intakes.forEach(i=>{
      const takenAt = new Date(i.takenAt);
      const diffHours = (time - takenAt)/(1000*60*60);
      if (diffHours >= 0) {
        total += i.caffeineMg * Math.pow(0.5, diffHours / HALF_LIFE_HOURS);
      }
    });
    return total;
  }
 function buildCaffeineSeries(rangeType) {
    const now = new Date();

    let start, end;
    const stepHours = 1; // 1ì‹œê°„ ê°„ê²©

    if (rangeType === 'week') {
      // ì˜¤ëŠ˜ í¬í•¨ ìµœê·¼ 7ì¼: (6ì¼ ì „ 0ì‹œ) ~ (ì˜¤ëŠ˜ ë‹¤ìŒë‚  0ì‹œ)
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
      start = new Date(today0);
      start.setDate(today0.getDate() - 6);

      end = new Date(today0);
      end.setDate(today0.getDate() + 1); // ë‹¤ìŒë‚  0ì‹œê¹Œì§€
    } else {
      // ì´ë²ˆ ë‹¬ 1ì¼ 0ì‹œ ~ ë‹¤ìŒ ë‹¬ 1ì¼ 0ì‹œ
      const y = now.getFullYear();
      const m = now.getMonth();
      start = new Date(y, m, 1, 0, 0, 0);
      end   = new Date(y, m + 1, 1, 0, 0, 0);
    }

    const labels = [];
    const data   = [];

    const t = new Date(start);
    while (t < end) {
      labels.push(
        `${t.getMonth() + 1}/${t.getDate()} ${String(t.getHours()).padStart(2, '0')}ì‹œ`
      );
      data.push(caffeineLevelAt(t));
      t.setHours(t.getHours() + stepHours);
    }

    return { labels, data };
  }
  // ğŸ“ˆ í˜ˆì¤‘ ì¹´í˜ì¸ ì„¸ë¶€ í™”ë©´ (ìµœê·¼ 7ì¼ / ì´ë²ˆ ë‹¬ ì¶”ì´)
  function renderBloodDetail() {
    const wrapper = document.getElementById('blood-detail-wrapper');
    if (!wrapper || wrapper.style.display === 'none') return;

    // ---------- 1) ìµœê·¼ 7ì¼ ----------
    const weekCanvas = document.getElementById('caffeine-chart-week');
    const weekText   = document.getElementById('caffeine-text-week');

    if (weekCanvas && weekText) {
      const { labels, data } = buildCaffeineSeries('week');

      const total = data.reduce((a, b) => a + b, 0);
      const avg   = data.length ? total / data.length : 0;

      weekText.innerHTML =
        `ìµœê·¼ 7ì¼ ë™ì•ˆ 1ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ê³„ì‚°í•œ <b>í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ ì¶”ì´</b>ì…ë‹ˆë‹¤.` +
        `<br>ì „ì²´ êµ¬ê°„ í‰ê· : <b>${avg.toFixed(1)}</b> (ìƒëŒ€ê°’ ê¸°ì¤€)`;

      const ctxW = weekCanvas.getContext('2d');
      if (!caffeineWeekChart) {
        caffeineWeekChart = new Chart(ctxW, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ (ìƒëŒ€ê°’)',
              data,
              tension: 0.3,
              fill: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      } else {
        caffeineWeekChart.data.labels = labels;
        caffeineWeekChart.data.datasets[0].data = data;
        caffeineWeekChart.update();
      }
    }

    // ---------- 2) ì´ë²ˆ ë‹¬ ----------
    const monthCanvas = document.getElementById('caffeine-chart-month');
    const monthText   = document.getElementById('caffeine-text-month');

    if (monthCanvas && monthText) {
      const { labels, data } = buildCaffeineSeries('month');

      const total = data.reduce((a, b) => a + b, 0);
      const avg   = data.length ? total / data.length : 0;

      monthText.innerHTML =
        `ì´ë²ˆ ë‹¬ 1ì¼ 0ì‹œë¶€í„° í˜„ì¬ê¹Œì§€ 1ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ê³„ì‚°í•œ <b>í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ ì¶”ì´</b>ì…ë‹ˆë‹¤.` +
        `<br>ì „ì²´ êµ¬ê°„ í‰ê· : <b>${avg.toFixed(1)}</b> (ìƒëŒ€ê°’ ê¸°ì¤€)`;

      const ctxM = monthCanvas.getContext('2d');
      if (!caffeineMonthChart) {
        caffeineMonthChart = new Chart(ctxM, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'í˜ˆì¤‘ ì¹´í˜ì¸ ë†ë„ (ìƒëŒ€ê°’)',
              data,
              tension: 0.3,
              fill: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      } else {
        caffeineMonthChart.data.labels = labels;
        caffeineMonthChart.data.datasets[0].data = data;
        caffeineMonthChart.update();
      }
    }
  }

  function updateCaffeineGraph() {
    const canvas = document.getElementById('caffeine-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);

    const rangeSel = document.getElementById('caffeine-range');
    const range = rangeSel ? rangeSel.value : 'full';
    let startHour = 0;
    let endHour = 24;
    if (range === 'school') { startHour = 6; endHour = 18; }
    else if (range === 'evening') { startHour = 18; endHour = 24; }
    else if (range === 'morning') { startHour = 6; endHour = 12; }

    const labels = [];
    const data = [];
    for (let h=startHour; h<endHour; h++) {
      const t = new Date(start);
      t.setHours(h);
      labels.push(`${h}ì‹œ`);
      data.push(caffeineLevelAt(t));
    }

    let maxDay = 0;
    for (let h=0; h<24; h++) {
      const t = new Date(start);
      t.setHours(h);
      maxDay = Math.max(maxDay, caffeineLevelAt(t));
    }
    if (maxDay < 1) maxDay = 1;

    if (!caffeineChart) {
      caffeineChart = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{ label:'ì¶”ì • í˜ˆì¤‘ ì¹´í˜ì¸ (ìƒëŒ€ê°’)', data, tension:0.3, fill:false }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    } else {
      caffeineChart.data.labels = labels;
      caffeineChart.data.datasets[0].data = data;
      caffeineChart.update();
    }

    const sleepInput = document.getElementById('sleep-time');
    let sleepTime = new Date(start);
    if (sleepInput && sleepInput.value) {
      const [hh,mm] = sleepInput.value.split(':').map(Number);
      sleepTime.setHours(hh, mm || 0, 0, 0);
    } else {
      sleepTime.setHours(23,0,0,0);
    }
    const levelAtSleep = caffeineLevelAt(sleepTime);
    const ratio = (levelAtSleep / maxDay) * 100;

    const threshold = maxDay * 0.25;
    let recommendedTime = null;
    for (let mins = 0; mins <= 24*60; mins += 30) {
      const t = new Date(start.getTime() + mins*60000);
      const lvl = caffeineLevelAt(t);
      if (lvl <= threshold) {
        recommendedTime = t;
        break;
      }
    }

    const sleepInfo = document.getElementById('sleep-info');
    if (!sleepInfo) return;

    let msg = `ì„ íƒí•œ ì·¨ì¹¨ ì‹œê°(${sleepTime.getHours()}ì‹œ ê¸°ì¤€)ì˜ ì¶”ì • ì”ì—¬ ì¹´í˜ì¸: <b>${levelAtSleep.toFixed(1)}</b> (ì˜¤ëŠ˜ ìµœëŒ€ì¹˜ ëŒ€ë¹„ ì•½ ${ratio.toFixed(0)}%)`;
    if (ratio > 60) {
      msg += ' â€” ì´ë•Œ ìë©´ <b>ì¹´í˜ì¸ ë†ë„ê°€ ìƒë‹¹íˆ ë†’ì€ ìƒíƒœ</b>ì—ì„œ ìê²Œ ë  ìˆ˜ ìˆì–´ìš”.';
    } else if (ratio > 30) {
      msg += ' â€” ë‹¤ì†Œ ë†’ì€ í¸ì´ë¼, ì ì´ ì–•ì•„ì§€ê±°ë‚˜ ì ë“œëŠ” ë° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    } else {
      msg += ' â€” ìˆ˜ë©´ì— í° ì˜í–¥ì„ ì¤„ ê°€ëŠ¥ì„±ì€ ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì€ í¸ì…ë‹ˆë‹¤. (ê°œì¸ì°¨ ì¡´ì¬)';
    }

    if (recommendedTime) {
      msg += `<br>ì¹´í˜ì¸ ë†ë„ê°€ ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì •ë˜ëŠ” ì‹œì (ìµœëŒ€ì¹˜ì˜ ì•½ 25% ì´í•˜ë¡œ ë–¨ì–´ì§€ëŠ” ì‹œê°„)ì€ <b>${recommendedTime.getHours()}ì‹œ ${String(recommendedTime.getMinutes()).padStart(2,'0')}ë¶„</b> ì „í›„ì…ë‹ˆë‹¤.`;
      msg += ' ê·¸ ë¶€ê·¼ì— ì ìë¦¬ì— ë“œëŠ” ê²ƒì´ ë” í¸ì•ˆí•œ ìˆ˜ë©´ì— ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.';
    } else {
      msg += '<br>ì˜¤ëŠ˜ ì„­ì·¨ëŸ‰ì´ ë§ì•„, í•˜ë£¨ ë™ì•ˆ ì¹´í˜ì¸ ë†ë„ê°€ ì¶©ë¶„íˆ ë–¨ì–´ì§€ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }

    sleepInfo.innerHTML = msg;
  }

  function renderEffectIcons() {
    const container = document.getElementById('effect-icons');
    if (!container) return;
    container.innerHTML = EFFECT_DEFS.map(e =>
      `<button type="button" class="effect-chip" data-id="${e.id}" data-label="${e.label}">
        <span>${e.icon}</span><span>${e.label}</span>
      </button>`
    ).join('');
  }
 function getAllProductShortcuts() {
    return [...PRODUCT_SHORTCUT_DEFS, ...userProductShortcuts];
  }

  function renderProductShortcuts() {
    const container = document.getElementById('product-shortcut-icons');
    if (!container) return;

    const all = getAllProductShortcuts();
    if (!all.length) {
      container.innerHTML = '<span class="small">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
      return;
    }

    container.innerHTML = all.map(p => `
      <button type="button"
              class="product-shortcut-chip"
              data-id="${p.id}">
        <span>${p.icon || 'â˜•'}</span>
        <span>${p.label}</span>
      </button>
    `).join('');
  }

  function renderSideEffectList() {
    const container = document.getElementById('side-effect-list');
    if (!container) return;
    if (!sideEffects.length) {
      container.textContent = 'ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }
    const items = sideEffects.slice().sort((a,b)=>new Date(b.occurredAt)-new Date(a.occurredAt));
    container.innerHTML = items.map(s=>{
      const d = new Date(s.occurredAt);
      return `<div class="effect-list-item">
        <span>${formatDateTimeView(d)}</span>
        <span>${s.effectLabel}${s.notes ? ' - ' + s.notes : ''}</span>
      </div>`;
    }).join('');
  renderRiskIndicator();
  }

  function renderPeerStories() {
    const storyBox = document.getElementById('peer-stories');
    const solutionBox = document.getElementById('peer-solutions');
    if (!storyBox || !solutionBox) return;

    // ì™¼ìª½: í›„ê¸°(ìƒí™©)
    storyBox.innerHTML = PEER_STORIES.map(s =>
      `<div style="margin-bottom:6px;">
         ${s.icon} <b>${s.label}</b><br>
         ${s.story}
       </div>`
    ).join('');

    // ì˜¤ë¥¸ìª½: í•´ê²° ë°©ë²•
    solutionBox.innerHTML = PEER_STORIES.map(s =>
      `<div style="margin-bottom:6px;">
         <b>${s.label}</b>ì¼ ë•Œ<br>
         ${s.solution}
       </div>`
    ).join('');
  }

function renderEffectDetailView(show) {
  const box  = document.getElementById('effects-detail-advanced');
  const body = document.getElementById('effects-detail-body');
  if (!box || !body) return;

  if (!show) {
    box.style.display = 'none';
    return;
  }
  box.style.display = 'block';

  if (!sideEffects.length) {
    body.textContent =
      'ì•„ì§ ì €ì¥ëœ ë¶€ì‘ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì¦ìƒ ì•„ì´ì½˜ì„ ì„ íƒí•˜ê³ , ë¶€ì‘ìš© ê¸°ë¡ì„ ì €ì¥í•´ ë³´ì„¸ìš”.';
    return;
  }

  // ì¦ìƒë³„ ê·¸ë£¹í™”
  const grouped = {};
  sideEffects.forEach(s => {
    const key = s.effectId || 'etc';
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(s);
  });

  const cards = Object.keys(grouped).map(effectId => {
    const list = grouped[effectId].slice().sort(
      (a,b) => new Date(b.occurredAt) - new Date(a.occurredAt)
    );
    const def  = EFFECT_DEFS.find(d => d.id === effectId);
    const peer = PEER_STORIES.find(p => p.id === effectId);

    const label = def ? def.label : (list[0].effectLabel || 'ê¸°íƒ€');
    const icon  = def ? def.icon : 'â“';

    const itemsHtml = list.map(s => {
      const d = new Date(s.occurredAt);
      return `
        <div style="padding:4px 0; border-bottom:1px dashed #d1fae5;">
          <div style="font-weight:600;">${formatDateTimeView(d)}</div>
          <div>${s.notes ? s.notes : '(ë©”ëª¨ ì—†ìŒ)'}</div>
        </div>
      `;
    }).join('');

    let helperHtml = '';
    if (def) {
      helperHtml += `<b>[ê¸°ë³¸ ëŒ€ì²˜ ë°©ë²•]</b><br>${def.tip}`;
    }
    if (peer) {
      helperHtml += `<br><br><b>[ë‹¤ë¥¸ í•™ìƒ í›„ê¸°/í•´ê²° ë°©ë²•]</b><br>${peer.story}<br>${peer.solution}`;
    }
    if (!helperHtml) {
      helperHtml = 'ì´ ì¦ìƒì— ëŒ€í•œ ê¸°ë³¸ ëŒ€ì²˜ ë°©ë²•ê³¼ í›„ê¸°ëŠ” ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
    }

    return `
      <div style="border-radius:10px; border:1px solid #a7f3d0; padding:8px; margin-top:8px; background:#ecfdf5;">
        <div style="font-weight:700; margin-bottom:4px; color:#065f46;">
          ${icon} ${label} (ì´ ${list.length}íšŒ)
        </div>
        <div style="margin-bottom:6px;">
          ${helperHtml}
        </div>
        <div style="max-height:160px; overflow:auto; background:#f0fdf4; border-radius:8px; padding:6px;">
          ${itemsHtml}
        </div>
      </div>
    `;
  });

  body.innerHTML = cards.join('');
}

// [B2] ë¶€ì‘ìš© ì´ë²¤íŠ¸/ì €ì¥ ë¡œì§ (ì´ ë¸”ë¡ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì¶”ê°€)

// ì–´ë–¤ ì•„ì´ì½˜ì„ ì„ íƒí–ˆëŠ”ì§€ ì €ì¥
let selectedEffectId = null;
let selectedEffectLabel = "";

// ë¶€ì‘ìš© ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
function bindEffectIconEvents() {
  const container = document.getElementById('effect-icons');
  const tipBox = document.getElementById('effect-tips');
  if (!container) return;

  container.addEventListener('click', (e) => {
    const btn = e.target.closest('.effect-chip');
    if (!btn) return;

    // ëª¨ë“  ì•„ì´ì½˜ ë¹„í™œì„±í™” â†’ í´ë¦­í•œ ì•„ì´ì½˜ë§Œ í™œì„±í™”
    document.querySelectorAll('.effect-chip').forEach(el => {
      el.classList.remove('active');
    });
    btn.classList.add('active');

    selectedEffectId = btn.dataset.id;
    selectedEffectLabel = btn.dataset.label;

    const def = EFFECT_DEFS.find(d => d.id === selectedEffectId);
    if (def && tipBox) {
      tipBox.style.display = 'block';
      tipBox.textContent = def.tip;
    }
  });
}

// ë¶€ì‘ìš© í¼ ì œì¶œ(ì €ì¥) ì²˜ë¦¬
function handleSideEffectSubmit(e) {
  e.preventDefault();

  if (!selectedEffectId) {
    alert('ë¨¼ì € ì¦ìƒ ì•„ì´ì½˜ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.');
    return;
  }

  const notesEl = document.getElementById('side-effect-notes');
  const timeEl  = document.getElementById('side-effect-time');

  const notes = notesEl ? notesEl.value.trim() : '';
  // ì‹œê°„ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì§€ê¸ˆ ì‹œê°ìœ¼ë¡œ
  const occurredAt = (timeEl && timeEl.value)
    ? timeEl.value
    : formatDateTimeLocal(new Date());

  const entry = {
    id: Date.now(),
    effectId: selectedEffectId,
    effectLabel: selectedEffectLabel,
    notes,
    occurredAt
  };

  sideEffects.push(entry);

  // ì˜¤ë¥¸ìª½ "ë‚´ ë¶€ì‘ìš© ê¸°ë¡" ì—…ë°ì´íŠ¸
  renderSideEffectList();

  // ì „ì²´ í™”ë©´ ëª¨ë“œì¼ ë• ìƒì„¸ ëª¨ì•„ë³´ê¸°ë„ ì¦‰ì‹œ ê°±ì‹ 
  if (extraDetailMode === 'effects') {
    renderEffectDetailView(true);
  } else {
    renderEffectDetailView(false);
  }

  // í¼ ì •ë¦¬
  if (notesEl) notesEl.value = '';
  if (timeEl && !timeEl.value) {
    timeEl.value = occurredAt;
  }

  alert('ë¶€ì‘ìš© ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// [B3] setExtraMode ë³´ì™„ ë²„ì „ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)
function setExtraMode(mode) {
  extraDetailMode = mode; // null or 'stats'|'blood'|'effects'|'banner'

  const ids = {
    stats: 'extra-section-stats',
    blood: 'extra-section-blood',
    effects: 'extra-section-effects',
    banner: 'extra-section-banner'
  };

  const allSections = Object.values(ids).map(id => document.getElementById(id));
  const backBtn = document.getElementById('extra-back-btn');

  if (!mode) {
    // í†µí•© ë³´ê¸°: ë„¤ ê°œ íŒ¨ë„ ëª¨ë‘ ë³´ì´ê¸°
    allSections.forEach(sec => { if (sec) sec.style.display = 'block'; });
    if (backBtn) backBtn.style.display = 'none';

    // í†µí•© í™”ë©´ì—ì„œëŠ” "ë¶€ì‘ìš© ìƒì„¸ ëª¨ì•„ë³´ê¸°"ëŠ” ì ‘ì–´ë‘ê¸°
    renderEffectDetailView(false);
  } else {
    // íŠ¹ì • ëª¨ë“œë§Œ ì „ì²´ í™”ë©´
    allSections.forEach(sec => { if (sec) sec.style.display = 'none'; });
    const target = document.getElementById(ids[mode]);
    if (target) target.style.display = 'block';
    if (backBtn) backBtn.style.display = 'inline-block';

    // ë¶€ì‘ìš© ëª¨ë“œì¼ ë•Œë§Œ 'ìƒì„¸ ëª¨ì•„ë³´ê¸°' ì—´ê¸°
    if (mode === 'effects') {
      renderEffectDetailView(true);
    } else {
      renderEffectDetailView(false);
    }
  }
    // ğŸ“Š í†µê³„ ì„¸ë¶€ ëª¨ë“œì¼ ë•Œë§Œ ê¸°ê°„ë³„ ì„¸ë¶€ ê·¸ë˜í”„ í‘œì‹œ
    const statsDetail = document.getElementById('stats-detail-wrapper');
    if (statsDetail) {
      if (mode === 'stats') {
        statsDetail.style.display = 'block';
        renderStatsDetail();
      } else {
        statsDetail.style.display = 'none';
      }
    }

    // ğŸ“ˆ í˜ˆì¤‘ ì¹´í˜ì¸ ì„¸ë¶€ ëª¨ë“œì¼ ë•Œë§Œ 1ì£¼/1ë‹¬ ì¶”ì´ ê·¸ë˜í”„ í‘œì‹œ
    const bloodDetail = document.getElementById('blood-detail-wrapper');
    if (bloodDetail) {
      if (mode === 'blood') {
        bloodDetail.style.display = 'block';
        renderBloodDetail();
      } else {
        bloodDetail.style.display = 'none';
      }
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

  function showHome() {
    document.getElementById('view-home').style.display = 'block';
    document.getElementById('view-intake').style.display = 'none';
    document.getElementById('view-extra').style.display = 'none';
    setExtraMode(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function goHome() {
    showHome();
  }

  function showExtraCombined() {
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-intake').style.display = 'none';
    document.getElementById('view-extra').style.display = 'block';
    setExtraMode(null);
  }

  function openStatsDetail() {
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-intake').style.display = 'none';
    document.getElementById('view-extra').style.display = 'block';
    setExtraMode('stats');
  }

  function openBloodDetail() {
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-intake').style.display = 'none';
    document.getElementById('view-extra').style.display = 'block';
    setExtraMode('blood');
  }

// [B4] ë¶€ì‘ìš© ì „ì²´ í™”ë©´ ì§„ì… í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)
function openEffectsDetail() {
  const home  = document.getElementById('view-home');
  const intake = document.getElementById('view-intake');
  const extra = document.getElementById('view-extra');

  if (home)   home.style.display = 'none';
  if (intake) intake.style.display = 'none';
  if (extra)  extra.style.display = 'block';

  // ë¶€ì‘ìš© íŒ¨ë„ë§Œ ì „ì²´ í™”ë©´ + ìƒì„¸ ëª¨ì•„ë³´ê¸° ON
  setExtraMode('effects');

  renderEffectDetailView(true);
}

  function openBannerDetail() {
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-intake').style.display = 'none';
    document.getElementById('view-extra').style.display = 'block';
    setExtraMode('banner');
  }

  function openIntake() {
    document.getElementById('view-home').style.display = 'none';
    document.getElementById('view-intake').style.display = 'block';
    document.getElementById('view-extra').style.display = 'none';
    setExtraMode(null);
    const form = document.getElementById('intake-form');
    if (form) {
      setTimeout(() => {
        window.scrollTo({
          top: form.getBoundingClientRect().top + window.scrollY - 60,
          behavior: 'smooth'
        });
      }, 50);
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      goHome();
    }
  });

  // === ë“œë˜ê·¸/íœ  ì œìŠ¤ì²˜: í™ˆ â†” ì¶”ê°€ ê¸°ëŠ¥ ===
  let dragStartY = null;
  let dragStartView = null;
  const DRAG_THRESHOLD = 120;

  function currentView() {
    const home = document.getElementById('view-home');
    const intake = document.getElementById('view-intake');
    const extra = document.getElementById('view-extra');
    if (intake && intake.style.display === 'block') return 'intake';
    if (extra && extra.style.display === 'block') return 'extra';
    if (home && home.style.display === 'block') return 'home';
    return 'home';
  }

  function handleTouchStart(e) {
    if (e.touches.length !== 1) return;
    dragStartY = e.touches[0].clientY;
    dragStartView = currentView();
  }
  function handleTouchMove(e) {
    if (dragStartY === null) return;
    const y = e.touches[0].clientY;
    const dy = y - dragStartY;

    if (dragStartView === 'home' && dy < -DRAG_THRESHOLD) {
      showExtraCombined();
      dragStartY = null;
      dragStartView = null;
    }
    if (dragStartView === 'extra' && dy > DRAG_THRESHOLD) {
      if (window.scrollY <= 10) {
        showHome();
        dragStartY = null;
        dragStartView = null;
      }
    }
  }
  function handleTouchEnd() {
    dragStartY = null;
    dragStartView = null;
  }

  document.addEventListener('touchstart', handleTouchStart, { passive: true });
  document.addEventListener('touchmove', handleTouchMove, { passive: true });
  document.addEventListener('touchend', handleTouchEnd, { passive: true });
  document.addEventListener('touchcancel', handleTouchEnd, { passive: true });

  let mouseDown = false;
  let mouseStartY = null;
  let mouseStartView = null;

  function handleMouseDown(e) {
    mouseDown = true;
    mouseStartY = e.clientY;
    mouseStartView = currentView();
  }
  function handleMouseMove(e) {
    if (!mouseDown || mouseStartY === null) return;
    const dy = e.clientY - mouseStartY;

    if (mouseStartView === 'home' && dy < -DRAG_THRESHOLD) {
      showExtraCombined();
      mouseDown = false;
      mouseStartY = null;
      mouseStartView = null;
    }
    if (mouseStartView === 'extra' && dy > DRAG_THRESHOLD) {
      if (window.scrollY <= 10) {
        showHome();
        mouseDown = false;
        mouseStartY = null;
        mouseStartView = null;
      }
    }
  }
  function handleMouseUp() {
    mouseDown = false;
    mouseStartY = null;
    mouseStartView = null;
  }

  document.addEventListener('mousedown', handleMouseDown);
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);

  function handleWheel(e) {
    const view = currentView();
    const dy = e.deltaY;
    if (view === 'intake') return;

    if (view === 'home' && dy > 0) {
      const nearBottom =
        window.scrollY + window.innerHeight >= document.body.scrollHeight - 40;
      if (nearBottom) {
        showExtraCombined();
      }
      return;
    }

    if (view === 'extra' && dy < 0) {
      if (window.scrollY <= 10) {
        showHome();
      }
      return;
    }
  }

  document.addEventListener('wheel', handleWheel, { passive: true });

  function renderMonthCalendarInit() {
    const now = new Date();
    renderMonthCalendar(now, []);
  }

function init() {
  const todayLabel = document.getElementById('today-date-label');
  const now = new Date();
  if (todayLabel) {
    todayLabel.textContent = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  }

  loadData();

  const intakeTime = document.getElementById('intake-time');
  if (intakeTime) intakeTime.value = formatDateTimeLocal(new Date());
  const seTime = document.getElementById('side-effect-time');
  if (seTime) seTime.value = formatDateTimeLocal(new Date());

  const sleepInput = document.getElementById('sleep-time');
  if (sleepInput) sleepInput.value = '23:00';

  // âœ… ë¶€ì‘ìš© ì•„ì´ì½˜/í›„ê¸°/ë¦¬ìŠ¤íŠ¸/ìƒì„¸ ì´ˆê¸°í™”
  renderEffectIcons();
  renderPeerStories();
  renderSideEffectList();
  renderEffectDetailView(false);   // ì²˜ìŒì—ëŠ” ìƒì„¸ ëª¨ì•„ë³´ê¸° ì ‘ê¸°
  renderProductShortcuts();

  // âœ… ë¶€ì‘ìš© í¼ ì´ë²¤íŠ¸ ì—°ê²°
  const seForm = document.getElementById('side-effect-form');
  if (seForm) {
    seForm.addEventListener('submit', handleSideEffectSubmit);
  }
  bindEffectIconEvents();

  // ê¸°ì¡´ í†µê³„/ê·¸ë˜í”„/ë‹¬ë ¥ ì´ˆê¸°í™”
  updateTodaySummary();
  renderMonthCalendarInit();
  updateStats();
  updateCaffeineGraph();
  updateEditSelect();
  renderBloodDetail();

  // ì´ˆê¸°ì—ëŠ” ìƒ˜í”Œë¡œ í…Œì´ë¸” ì±„ì›Œë‘ê¸°
  renderPopularProducts(POPULAR_PRODUCTS_SAMPLE);

  showHome();
}

  init();

  // í”Œë¡œíŒ… ë²„íŠ¼/ì˜¤ë²„ë ˆì´
  const fabButton = document.getElementById('fab-menu-button');
  const fabOverlay = document.getElementById('fab-overlay');

  if (fabButton && fabOverlay) {
    fabButton.addEventListener('click', () => {
      fabOverlay.style.display = 'flex';
    });

    fabOverlay.addEventListener('click', (e) => {
      if (e.target === fabOverlay) {
        fabOverlay.style.display = 'none';
      }
    });

    document.querySelectorAll('#fab-menu button').forEach(btn => {
      btn.addEventListener('click', () => {
        fabOverlay.style.display = 'none';
      });
    });
  }
</script>
</body>
</html>
